



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="露の世" href="https://lhchen74.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="露の世" href="https://lhchen74.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="露の世" href="https://lhchen74.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="other" />


<link rel="canonical" href="https://lhchen74.github.io/2021/03/13/bcrypt/">



  <title>
Hashing in Action Understanding bcrypt |
D E W = 露の世</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Hashing in Action Understanding bcrypt
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2021-03-13 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2021-03-13T00:00:00+08:00">2021-03-13</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">D E W</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclh0m9pdj20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicitf0kl1j20zk0m87fe.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giciuv0socj20zk0m8qes.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclg5ms2rj20zk0m8u0x.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li>
          <li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipevgoki5j20zk0m84qp.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://lhchen74.github.io/2021/03/13/bcrypt/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="江边鸟">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="露の世">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>转载: <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9oYXNoaW5nLWluLWFjdGlvbi11bmRlcnN0YW5kaW5nLWJjcnlwdC8=">Hashing in Action Understanding bcrypt</span></p>
</blockquote>
<p>The bcrypt hashing function allows us to build a password security platform that scales with computation power and always hashes every password with a salt.</p>
<p>In previous posts to this Authentication Saga, we learned that storing passwords in <strong>plaintext</strong> must never be an option. Instead, we want to provide a <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9oYXNoaW5nLXBhc3N3b3Jkcy1vbmUtd2F5LXJvYWQtdG8tc2VjdXJpdHkv">one-way road to security</span> by <strong>hashing</strong> passwords. However, we also explored that hashing alone is not sufficient to mitigate more involved attacks such as rainbow tables. A <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9hZGRpbmctc2FsdC10by1oYXNoaW5nLWEtYmV0dGVyLXdheS10by1zdG9yZS1wYXNzd29yZHMv">better way to store passwords</span> is to add a salt to the hashing process: adding additional random data to the input of a hashing function that makes each password hash unique. The ideal authentication platform would integrate these two processes, hashing and salting, seamlessly.</p>
<p>There are plenty of cryptographic functions to choose from such as the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SHA-2"> <code>SHA2</code>  family</a> and the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SHA-3"> <code>SHA-3</code>  family</a>. However, one design problem with the  <code>SHA</code>  families is that they were designed to be computationally fast. How fast a cryptographic function can calculate a hash has an immediate and significant bearing on how safe the password is.</p>
<p>Faster calculations mean faster brute-force attacks, for example. Modern hardware in the form of CPUs and GPUs could compute millions, or even billions, of SHA-256 hashes per second against a stolen database. Instead of a fast function, we need a function that is slow at hashing passwords to bring attackers almost to a halt. We also want this function to be adaptive so that we can compensate for future faster hardware by being able to make the function run slower and slower over time.</p>
<p>At Auth0, the integrity and security of our data are one of our highest priorities. We use the industry-grade and battle-tested  <code>bcrypt</code>  algorithm to securely hash <strong>and</strong> salt passwords.  <code>bcrypt</code>  allows building a password security platform that can evolve alongside hardware technology to guard against the threats that the future may bring, such as attackers having the computing power to crack passwords twice as fast. Let’s learn about the design and specifications that make  <code>bcrypt</code>  a cryptographic security standard.</p>
<p>Technology changes fast. Increasing the speed and power of computers can benefit both the engineers trying to build software systems and the attackers trying to exploit them. Some cryptographic software is not designed to scale with computing power. As explained earlier, the safety of the password depends on how fast the selected cryptographic hashing function can calculate the password hash. A fast function would execute faster when running in much more powerful hardware.</p>
<p>To mitigate this attack vector, we could create a cryptographic hash function that can be tuned to run slower in newly available hardware; that is, the function scales with computing power. This is particularly important since, through this attack vector, people tend to keep the length of the passwords constant. Hence, in the design of a cryptographic solution for this problem, <strong>we must account for rapidly evolving hardware and constant password length</strong>.</p>
<p>This attack vector was well understood by cryptographers in the 90s and an algorithm by the name of  <code>bcrypt</code>  that met these design specifications was <span class="exturl" data-url="aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9sZWdhY3kvZXZlbnRzL3VzZW5peDk5L3Byb3Zvcy9wcm92b3NfaHRtbC9ub2RlMS5odG1s">presented in 1999 at USENIX</span>. Let’s learn how  <code>bcrypt</code>  allows us to create strong password storage systems.</p>
<p><code>bcrypt</code>  was designed by <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9OaWVsc1Byb3Zvcw==">Niels Provos</span> and <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9kbWF6aWVyZXM=">David Mazières</span> based on the <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmxvd2Zpc2hfKGNpcGhlcik=">Blowfish cipher</span>:  <code>b</code>  for Blowfish and  <code>crypt</code>  for the name of the hashing function used by the UNIX password system.</p>
<p><code>crypt</code>  is a great example of failure to adapt to technology changes. <span class="exturl" data-url="aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9sZWdhY3kvZXZlbnRzL3VzZW5peDk5L3Byb3Zvcy9wcm92b3NfaHRtbC9ub2RlMS5odG1s">According to USENIX</span>, in 1976,  <code>crypt</code>  could hash fewer than 4 passwords per second. Since <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvUHJlaW1hZ2VfYXR0YWNr">attackers need to find the pre-image of a hash</span> in order to invert it, this made the UNIX Team feel very comfortable about the strength of  <code>crypt</code> . However, 20 years later, a fast computer with optimized software and hardware was capable of hashing 200,000 passwords per second using that function!</p>
<p>Inherently, an attacker could then carry out a complete <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvRGljdGlvbmFyeV9hdHRhY2s=">dictionary attack</span> with extreme efficiency. Thus, cryptography that was exponentially more difficult to break as hardware became faster was required in order to hinder the speed benefits that attackers could get from hardware.</p>
<p>The Blowfish cipher is a fast <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmxvY2tfY2lwaGVy">block cipher</span> except when changing <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvS2V5XyhjcnlwdG9ncmFwaHkp">keys</span>, the parameters that establish the functional output of a cryptographic algorithm: each new key requires the <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmxvd2Zpc2hfKGNpcGhlcik=">pre-processing equivalent to encrypting about 4 kilobytes of text</span>, which is considered very slow compared to other block ciphers. This slow key changing is beneficial to password hashing methods such as  <code>bcrypt</code>  since the extra computational demand helps protect against dictionary and brute force attacks by <strong>slowing down the attack</strong>.</p>
<p>As shown in <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmxvd2Zpc2hfKGNpcGhlcik=">“Blowfish in practice”</span>,  <code>bcrypt</code>  is able to mitigate those kinds of attacks by combining the expensive key setup phase of Blowfish with a variable number of iterations to increase the workload and duration of hash calculations. The largest benefit of  <code>bcrypt</code>  is that, over time, the <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmNyeXB0">iteration count can be increased to make it slower</span> allowing  <code>bcrypt</code>  to scale with computing power. We can dimish any benefits attackers may get from faster hardware by increasing the number of iterations to make  <code>bcrypt</code>  slower.</p>
<p>Another benefit of  <code>bcrypt</code>  is that it requires a salt by default. Let’s take a deeper look at how this hashing function works!</p>
<p>Provos and Mazières, the designers of  <code>bcrypt</code> , used the expensive key setup phase of the Blowfish cipher to develop a <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmNyeXB0">new key setup algorithm for Blowfish</span> named “eksblowfish”, which stands for “expensive key schedule Blowfish.”</p>
<blockquote>
<p><strong>What’s “key setup”?</strong> According to <span class="exturl" data-url="aHR0cHM6Ly9pYW5ob3dzb24uY29tLw==">Ian Howson</span>, a software engineer at NVIDIA: “Most ciphers consist of a key setup phase and an operation phase. During key setup, the internal state is initialised. During operation, input ciphertext or plaintext is encrypted or decrypted. Key setup only needs to be conducted once for each key that is used” <a target="_blank" rel="noopener" href="https://www.usenix.org/legacy/events/usenix99/provos/provos_html/node5.html#fig:bcrypt"> <code>bcrypt</code>  runs in two phases</a>:</p>
</blockquote>
<p><strong>Phase 1:</strong></p>
<p>A function called  <code>EksBlowfishSetup</code>  is setup using the desired cost, the salt, and the password to initialize the state of  <code>eksblowfish</code> . Then,  <code>bcrypt</code>  spends a lot of time running an expensive key schedule which consists of performing a <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvS2V5X2Rlcml2YXRpb25fZnVuY3Rpb24=">key derivation</span> where we derive a set of subkeys from a primary key. Here, the password is used as the primary key. In case that the user selected a bad or short password, we stretch that password/key into a longer password/key. The aforementioned practice is also known as <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvS2V5X3N0cmV0Y2hpbmc=">key stretching</span>.</p>
<p>What we are going through this first phase is to promote <span class="exturl" data-url="aHR0cHM6Ly9jcnlwdG8uc3RhY2tleGNoYW5nZS5jb20vcXVlc3Rpb25zLzQ2NTUwL2JlbmNobWFyay1kaWZmZXJlbmNlcy1iZXR3ZWVuLXNoYS01MTItYW5kLWJjcnlwdA==">key strengthening</span> to slow down calculations which in turn also slow down attackers.</p>
<p><strong>Phase 2:</strong></p>
<p>The magic value is the 192-bit value  <code>OrpheanBeholderScryDoubt</code> . This value is encrypted 64 times using  <code>eksblowfish</code>  in <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmxvY2tfY2lwaGVyX21vZGVfb2Zfb3BlcmF0aW9uI0VsZWN0cm9uaWNfQ29kZWJvb2tfKEVDQik=">ECB mode</span> with the state from the previous phase. The output of this phase is the cost and the 128-bit salt value concatenated with the result of the encryption loop.</p>
<img data-src="/2021/03/13/bcrypt/bcrypt-algo.png" class="" title="Algorithm that shows the two phases that make up the bcrypt implementation">
<p>The resulting hash is prefixed with  <code>$2a$</code> ,  <code>$2y$</code> , or  <code>$2b$</code> . The prefixes are added to indicate usage of  <code>bcrypt</code>  and its version.</p>
<p>The result of  <code>bcrypt</code>  achieves <span class="exturl" data-url="aHR0cHM6Ly93d3cudXNlbml4Lm9yZy9sZWdhY3kvZXZlbnRzL3VzZW5peDk5L3Byb3Zvcy9wcm92b3NfaHRtbC9ub2RlMy5odG1sI3NlYzpkZXNpZ24=">core properties of a secure password function</span> as defined by its designers:</p>
<ul>
<li>It’s preimage resistant.</li>
<li>The salt space is large enough to mitigate precomputation attacks, such as rainbow tables.</li>
<li>It has an adaptable cost.</li>
</ul>
<p>The designers of  <code>bcrypt</code>  believe that the function will hold its strength and value for many years. Its mathematical design gives assurance to cryptographers about its resilience to attacks.</p>
<p>Regarding adaptable cost, we could say that  <code>bcrypt</code>  is an adaptive hash function as we are able to increase the number of iterations performed by the function based on a passed key factor, the cost. This adaptability is what allows us to compensate for increasing computer power, but it comes with an opportunity cost: speed or security?</p>
<p>The challenge of security engineers is to decide what cost to set for the function. This cost is also known as the <strong>work factor</strong>. OWASP recommends as a <span class="exturl" data-url="aHR0cHM6Ly9jaGVhdHNoZWV0c2VyaWVzLm93YXNwLm9yZy9jaGVhdHNoZWV0cy9QYXNzd29yZF9TdG9yYWdlX0NoZWF0X1NoZWV0Lmh0bWwjd29yay1mYWN0b3Jz">common rule of thumb for work factor setting</span> to tune the cost so that the function runs as slow as possible without affecting the users’ experience and without increasing the need to use additional hardware that may be over budget.</p>
<p>Let’s take a closer look at an example based on OWASP recommendations:</p>
<ul>
<li>Perform UX research to find what are acceptable user wait times for registration and authentication.</li>
<li>If the accepted wait time is 1 second, tune the cost of  <code>bcrypt</code>  for it to run in 1 second on your hardware.</li>
<li>Analyze with your security team if the computation time is enough to mitigate and slow down attacks.</li>
</ul>
<p>Users may be fine waiting for 1 or 2 seconds as they don’t have to consistently authenticate. The process could still be perceived as quick. Whereas, this delay would frustrate the efforts of an attacker to quickly compute a rainbow table.</p>
<p>Being able to tune the cost of  <code>bcrypt</code>  allow us to scale with hardware optimization. Following a modern definition of <span class="exturl" data-url="aHR0cHM6Ly93d3cuaW52ZXN0b3BlZGlhLmNvbS90ZXJtcy9tL21vb3Jlc2xhdy5hc3A=">Moore’s Law</span>, the number of transistors per square inch on integrated systems has been doubling approximately every 18 months. In 2 years, we could increase the cost factor to accommodate any change. However, we need to be careful with this: if we simply increase the work factor of bcrypt in our code, everyone will be locked out. A migration process is necessary in this case.</p>
<blockquote>
<p>Check out a cool <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTW9vcmUnc19sYXcjL21lZGlhL0ZpbGU6TW9vcmUnc19MYXdfVHJhbnNpc3Rvcl9Db3VudF8xOTcxLTIwMTYucG5n">graph that shows the numbers of transistors on integrated circuit chips</span> from 1971 to 2016.</p>
</blockquote>
<p>As an example on how the increasing the work factor increases the work time, I created a Node.js script that computed the hash of  <code>DFGh5546*%^__90</code>  using a cost from 10 to 20.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> saltRounds = <span class="number">10</span>; saltRounds &lt; <span class="number">21</span>; saltRounds++) &#123;</span><br><span class="line">  <span class="built_in">console</span>.time(<span class="string">`bcrypt | cost: <span class="subst">$&#123;saltRounds&#125;</span>, time to hash`</span>);</span><br><span class="line">  bcrypt.hashSync(plainTextPassword1, saltRounds);</span><br><span class="line">  <span class="built_in">console</span>.timeEnd(<span class="string">`bcrypt | cost: <span class="subst">$&#123;saltRounds&#125;</span>, time to hash`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In the next section, we are going to explore the Node.js implementation in more detail. The script was run on a 2017 MacBook Pro with the following specs (We get nice equipment at Auth0! <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vY2FyZWVycw==">Join us</span>!):</p>
</blockquote>
<ul>
<li>Processor: 2.8 GHz Intel Core i7</li>
<li>Memory: 16 GB 2133 MHz LPDDR3</li>
<li>Graphics: Radeon Pro 555 2048 MB, Intel HD Graphics 630 1536 MB</li>
</ul>
<p>These are the results:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bcrypt | cost: 10, time to hash: 65.683ms</span><br><span class="line">bcrypt | cost: 11, time to hash: 129.227ms</span><br><span class="line">bcrypt | cost: 12, time to hash: 254.624ms</span><br><span class="line">bcrypt | cost: 13, time to hash: 511.969ms</span><br><span class="line">bcrypt | cost: 14, time to hash: 1015.073ms</span><br><span class="line">bcrypt | cost: 15, time to hash: 2043.034ms</span><br><span class="line">bcrypt | cost: 16, time to hash: 4088.721ms</span><br><span class="line">bcrypt | cost: 17, time to hash: 8162.788ms</span><br><span class="line">bcrypt | cost: 18, time to hash: 16315.459ms</span><br><span class="line">bcrypt | cost: 19, time to hash: 32682.622ms</span><br><span class="line">bcrypt | cost: 20, time to hash: 66779.182ms</span><br></pre></td></tr></table></figure>
<p>Plotting this data in <span class="exturl" data-url="aHR0cHM6Ly93d3cud29sZnJhbWFscGhhLmNvbS9pbnB1dC8/aT1leHBvbmVudGlhbCtmaXQrNjUuNjgzLCsxMjkuMjI3LCsyNTQuNjI0LCs1MTEuOTY5LCsxMDE1LjA3MywrMjA0My4wMzQsKzQwODguNzIxLDgxNjIuNzg4LDE2MzE1LjQ1OSwzMjY4Mi42MjIsKzY2Nzc5LjE4Mg==">Wolfram Alpha</span> to create a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Least_squares"><strong>least-squares fit</strong></a> graph, we observe that the time to hash a password grows exponentially as the cost is increased in this particular hardware configuration:</p>
<img data-src="/2021/03/13/bcrypt/graph.gif" class="" title="Plot of least-squares best fit for bcrypt hashing times data based on cost increases">
<p>For this data set, Wolfram Alpha gives us the following least-squares best fit equation:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">28.3722 e^(0.705681x)</span><br></pre></td></tr></table></figure>
<p>If we wanted to predict how long would it take to hash a password in this system when the cost is  <code>30</code> , we could simply plug that value for  <code>x</code> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">28.3722 e^(0.705681(30)) &#x3D; 44370461014.7</span><br></pre></td></tr></table></figure>
<p>A cost factor of  <code>30</code>  could take  <code>44370461014.7</code>  milliseconds to calculate. That is,  <code>739507.68</code>  minutes or  <code>513.55</code>  days! A much faster machine optimized with the latest and the greatest technology available today could have smaller computation times. However,  <code>bcrypt</code>  can easily scale our hashing process to accommodate to faster hardware, leaving us a lot of wiggle room to prevent attackers from benefiting from future technology improvements.</p>
<p>If a company ever detects or suspects that a data breach has compromised passwords, even in hash form, it must prompt its users to change their password right away. While hashing and salting prevent a brute-force attack of billions of attempts to be successful, a single password crack is computationally feasible. An attacker may, with tremendous amount of computational power, or by sheer luck, crack a single password, but even then, the process would be most certainly slow due to the characteristics of  <code>bcrypt</code> , giving the company and their users precious time to change passwords.</p>
<p>Now that we understand how  <code>bcrypt</code>  works, let’s explore how it can be implemented in a web application at a high level.</p>
<p>We are going to explore its implementation using <span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2VuLw==">Node.js</span> and its popular <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2tlbGVrdGl2L25vZGUuYmNyeXB0Lmpz">node.bcrypt.js</span> implementation. You don’t need to create a Node.js project. The purpose of this section is to show the common steps that developers have to take when integrating  <code>bcrypt</code>  in their backend.</p>
<p><code>node.bcrypt.js</code>  is installed via <a target="_blank" rel="noopener" href="https://www.npmjs.com/"> <code>npm</code> </a>, a Node.js package manager via the following command:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install bcrypt</span><br></pre></td></tr></table></figure>
<p>Then, on an entry-point file for the server, such as  <code>app.js</code> , we create a set of variables to refer throughout the implementation:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> saltRounds = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br></pre></td></tr></table></figure>
<p><code>bcrypt</code>  gives us access to a Node.js library that has utility methods to facilitate the hashing process.  <code>saltRounds</code>  represent the cost or work factor. We are going to use a random password,  <code>plainTextPassword1</code> , for the example.</p>
<p>This Node.js implementation is interesting because it gives us two different techniques to hash the passwords. Let’s explore them.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> saltRounds = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br><span class="line">bcrypt</span><br><span class="line">  .genSalt(saltRounds)</span><br><span class="line">  .then(<span class="function"><span class="params">salt</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Salt: <span class="subst">$&#123;salt&#125;</span>`</span>);</span><br><span class="line">    <span class="keyword">return</span> bcrypt.hash(plainTextPassword1, salt);</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">hash</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hash: <span class="subst">$&#123;hash&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// Store hash in your password DB.</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err.message));</span><br></pre></td></tr></table></figure>
<p>Using the <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvUHJvbWlzZQ==">Promise</span> pattern to control the asynchronous nature of JavaScript, in this technique, we first create a salt through the  <code>bcrypt.genSalt</code>  function that takes the cost,  <code>saltRounds</code> . Upon success, we get a  <code>salt</code>  value that we then pass to  <code>bcrypt.hash</code>  along with the password,  <code>plainTextPassword1</code> , that we want to hash. The success of  <code>bcrypt.hash</code>  provides us with the hash that we need to store in our database. In a full implementation, we would also want to store a username along with the hash in this final step.</p>
<p>Notice that I included some  <code>console.log</code>  statements to show the values of the  <code>salt</code>  and the  <code>hash</code>  as the process went along. Something that is really helpful in this implementation is that you do not have to create the  <code>salt</code>  yourself. The library creates a strong salt for you.</p>
<p>In the first run, I got the following results in the command line:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Salt: $2b$<span class="number">10</span>$<span class="comment">//DXiVVE59p7G5k/4Klx/e</span></span><br><span class="line">Hash: $2b$<span class="number">10</span>$<span class="comment">//DXiVVE59p7G5k/4Klx/ezF7BI42QZKmoOD0NDvUuqxRE5bFFBLy</span></span><br></pre></td></tr></table></figure>
<p>You won’t be able to 转载 these results again since the salt is completely random every time  <code>genSalt</code>  is run. Running it again, I got the following output:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Salt: $2b$<span class="number">10</span>$3euPcmQFCiblsZeEu5s7p.</span><br><span class="line">Hash: $2b$<span class="number">10</span>$3euPcmQFCiblsZeEu5s7p.9OVHgeHWFDk9nhMqZ0m/3pd/lhwZgES</span><br></pre></td></tr></table></figure>
<p>Hence, each password that we hash is going to have a unique salt and a unique hash. As <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vYmxvZy9hZGRpbmctc2FsdC10by1oYXNoaW5nLWEtYmV0dGVyLXdheS10by1zdG9yZS1wYXNzd29yZHMv">we learned before</span>, this helps us mitigate greatly rainbow table attacks.</p>
<p>In this version, we use a single function to both create the salt and hash the password:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> saltRounds = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br><span class="line">bcrypt</span><br><span class="line">  .hash(plainTextPassword1, saltRounds)</span><br><span class="line">  .then(<span class="function"><span class="params">hash</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Hash: <span class="subst">$&#123;hash&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// Store hash in your password DB.</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err.message));</span><br></pre></td></tr></table></figure>
<p>This technique has a smaller footprint and may be easier to test. Again, a new hash is created each time the function is run, regardless of the password being the same.</p>
<p>Notice how in both techniques we are storing the hash and not the password. <strong>The user’s password itself should not be stored anywhere in plaintext</strong>.</p>
<p>Once we have our password hashes stored in the database, how do we validate a user login? Let’s check that out.</p>
<p>Using the  <code>bcrypt.hash</code>  method, let’s see how we can compare a provided password with a stored hash. Since we are not connecting to a database in this example, we are going to create the hash and save it somewhere, like a text editor. The hash I got is:</p>
<p><code>$2b$10$69SrwAoAUNC5F.gtLEvrNON6VQ5EX89vNqLEqU655Oy9PeT/HRM/a</code> .</p>
<p>Next, we are going to check the passwords and see how they match. First, we check if our stored hash matches the hash of the provided password:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> hash = <span class="string">&quot;$2b$10$69SrwAoAUNC5F.gtLEvrNON6VQ5EX89vNqLEqU655Oy9PeT/HRM/a&quot;</span>;</span><br><span class="line">bcrypt</span><br><span class="line">  .compare(plainTextPassword1, hash)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err.message));</span><br></pre></td></tr></table></figure>
<p>In this case,  <code>res</code>  is  <code>true</code> , indicating that the password provided, when hashed, matched the stored hash.</p>
<p>Opposite, we expect to get  <code>false</code>  for  <code>res</code>  if we check the hash against  <code>plainTextPassword2</code> :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&quot;bcrypt&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> plainTextPassword1 = <span class="string">&quot;DFGh5546*%^__90&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> plainTextPassword2 = <span class="string">&quot;456kin&amp;*jhjUHJ1&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> hash = <span class="string">&quot;$2b$10$69SrwAoAUNC5F.gtLEvrNON6VQ5EX89vNqLEqU655Oy9PeT/HRM/a&quot;</span>;</span><br><span class="line">bcrypt</span><br><span class="line">  .compare(plainTextPassword2, hash)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.error(err.message));</span><br></pre></td></tr></table></figure>
<p>And, effectively,  <code>res</code>  is false. We did not store the salt though, so how does  <code>bcrypt.compare</code>  know which salt to use? Looking at a previous hash/salt result, notice how the hash is the salt with the hash appended to it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Salt: $2b$<span class="number">10</span>$3euPcmQFCiblsZeEu5s7p.</span><br><span class="line">Hash: $2b$<span class="number">10</span>$3euPcmQFCiblsZeEu5s7p.9OVHgeHWFDk9nhMqZ0m/3pd/lhwZgES</span><br></pre></td></tr></table></figure>
<p><code>bcrypt.compare</code>  deduces the salt from the hash and is able to then hash the provided password correctly for comparison.</p>
<p>That’s the flow of using  <code>bcrypt</code>  in Node.js. This example is very trivial and there are a lot of others things to care about such as storing username, ensuring the whole backend application is secure, doing security tests to find vulnerabilities. Hashing a password, though essential, is just a small part of a sound security strategy.</p>
<p>Other languages would follow a similar workflow:</p>
<ul>
<li>Here’s an <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNwcmluZy5pby9zcHJpbmctc2VjdXJpdHkvc2l0ZS9kb2NzLzQuMi41LlJFTEVBU0UvYXBpZG9jcy9vcmcvc3ByaW5nZnJhbWV3b3JrL3NlY3VyaXR5L2NyeXB0by9iY3J5cHQvQkNyeXB0Lmh0bWw=">example using Spring Security</span> for Java.</li>
<li>This <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRqYW5nb3Byb2plY3QuY29tL2VuLzMuMC90b3BpY3MvYXV0aC9wYXNzd29yZHMvI3VzaW5nLWJjcnlwdC13aXRoLWRqYW5nbw==">example uses Django</span> for Python.</li>
<li>Finally, this <span class="exturl" data-url="aHR0cHM6Ly9sYXJhdmVsLmNvbS9kb2NzLzUuMC9oYXNoaW5n">example uses Laravel</span> for PHP.</li>
</ul>
<p>The main idea of password verification is to compare two hashes and determine if they match each other. The process is very complex. A solid identity strategy demands an organization to keep current with cryptographic advances, design a process to phase out deprecated or vulnerable algorithms, provide pen testing, invest in physical and network security among many others. With all factors considered, it isn’t easy or inexpensive.</p>
<p>You can minimize the overhead of hashing, salting and password management through <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20v">Auth0</span>. We solve the most complex identity use cases with an extensible and easy to integrate platform that secures billions of logins every month.</p>
<p>Auth0 helps you prevent critical identity data from falling into the wrong hands. We never store passwords in cleartext. Passwords are always hashed and salted using <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQmNyeXB0">bcrypt</span>. We’ve built state-of-the-art security into our product, to protect your business and your users.</p>
<p>Make the internet safer, <span class="exturl" data-url="aHR0cHM6Ly9hdXRoMC5jb20vc2lnbnVw">sign up for a free Auth0 account</span> today.</p>

      <div class="tags">
          <a href="/tags/other/" rel="tag"><i class="ic i-tag"></i> other</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2021-10-18 13:27:05" itemprop="dateModified" datetime="2021-10-18T13:27:05+08:00">2021-10-18</time>
  </span>
</div>

      

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2021/03/13/java-hash/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciuv0socj20zk0m8qes.jpg" title="字典、哈希与Map">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>字典、哈希与Map</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2021/03/13/python-pathlib/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclg5ms2rj20zk0m8u0x.jpg" title="Discovering Python 3’s pathlib">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Discovering Python 3’s pathlib</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="江边鸟"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">江边鸟</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">278</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">2</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">40</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xoY2hlbjc0" title="https:&#x2F;&#x2F;github.com&#x2F;lhchen74"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;"><i class="ic i-cloud-music"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2021/03/13/java-hash/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2021/03/13/python-pathlib/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">江边鸟 @ D E W</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2021/03/13/bcrypt/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
