



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="我知这世界本如露水般短暂 然而 然而" href="https://lhchen74.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="我知这世界本如露水般短暂 然而 然而" href="https://lhchen74.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="我知这世界本如露水般短暂 然而 然而" href="https://lhchen74.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="js,rust" />


<link rel="canonical" href="https://lhchen74.github.io/2021/08/07/rust-webassembly/">



  <title>
Compiling from Rust to WebAssembly |
露の世 = 我知这世界本如露水般短暂 然而 然而</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Compiling from Rust to WebAssembly
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2021-08-07 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2021-08-07T00:00:00+08:00">2021-08-07</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">露の世</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph47e9vtj20zk0m8x6l.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicitcxhpij20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclflwv2aj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeyhsblkj20zk0m81kx.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclfdu6exj20zk0m87hw.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://lhchen74.github.io/2021/08/07/rust-webassembly/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="江边鸟">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="我知这世界本如露水般短暂 然而 然而">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>If you have some Rust code, you can compile it into <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWJBc3NlbWJseQ==">WebAssembly</span> (wasm). This tutorial takes you through all you need to know to compile a Rust project to wasm and use it in an existing web app.</p>
<h2 id="rust-and-webassembly-use-cases"><a class="markdownIt-Anchor" href="#rust-and-webassembly-use-cases">#</a> Rust and WebAssembly use cases</h2>
<p>There are two main use cases for Rust and WebAssembly:</p>
<ul>
<li>Build an entire application - an entire web app based in Rust.</li>
<li>Build a part of an application - using Rust in an existing JavaScript frontend.</li>
</ul>
<p>For now, the Rust team is focusing on the latter case, and so that’s what we cover here. For the former case, check out projects like <a target="_blank" rel="noopener" href="https://github.com/DenisKolodin/yew"> <code>yew</code> </a>.</p>
<p>In this tutorial, we build a package using  <code>wasm-pack</code> , a tool for building JavaScript packages in Rust. This package will contain only WebAssembly and JavaScript code, and so the users of the package won’t need Rust installed. They may not even notice that it’s written in Rust.</p>
<h2 id="rust-environment-setup"><a class="markdownIt-Anchor" href="#rust-environment-setup">#</a> Rust Environment Setup</h2>
<p>Let’s go through all the required steps to get our environment set up.</p>
<h3 id="install-rust"><a class="markdownIt-Anchor" href="#install-rust">#</a> Install Rust</h3>
<p>Install Rust by going to the <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVzdC1sYW5nLm9yZy9pbnN0YWxsLmh0bWw=">Install Rust</span> page and following the instructions. This installs a tool called “rustup”, which lets you manage multiple versions of Rust. By default, it installs the latest stable Rust release, which you can use for general Rust development. Rustup installs  <code>rustc</code> , the Rust compiler, as well as  <code>cargo</code> , Rust’s package manager,  <code>rust-std</code> , Rust’s standard libraries, and some helpful docs -  <code>rust-docs</code> .</p>
<p><strong>Note</strong>: Pay attention to the post-install note about needing cargo’s  <code>bin</code>  directory in your system  <code>PATH</code> . This is added automatically, but you must restart your terminal for it to take effect.</p>
<h3 id="wasm-pack"><a class="markdownIt-Anchor" href="#wasm-pack">#</a> wasm-pack</h3>
<p>To build the package, we need an additional tool,  <code>wasm-pack</code> . This helps compile the code to WebAssembly, as well as produce the right packaging for use in the browser. To download and install it, enter the following command into your terminal:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cargo install wasm-pack</span></span><br></pre></td></tr></table></figure>
<h2 id="building-our-webassembly-package"><a class="markdownIt-Anchor" href="#building-our-webassembly-package">#</a> Building our WebAssembly package</h2>
<p>Enough setup; let’s create a new package in Rust. Navigate to wherever you keep your personal projects, and type this:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cargo new --lib hello-wasm</span></span><br><span class="line">     Created library `hello-wasm` project</span><br></pre></td></tr></table></figure>
<p>This creates a new library in a subdirectory named  <code>hello-wasm</code>  with everything you need to get going:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+-- Cargo.toml</span><br><span class="line">+-- src</span><br><span class="line">    +-- lib.rs</span><br></pre></td></tr></table></figure>
<p>First, we have  <code>Cargo.toml</code> ; this is the file that we use to configure our build. If you’ve used  <code>Gemfile</code>  from Bundler or  <code>package.json</code>  from npm, this is likely to be familiar; Cargo works in a similar manner to both of them.</p>
<p>Next, Cargo has generated some Rust code for us in  <code>src/lib.rs</code> :</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> tests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">it_works</span></span>() &#123;</span><br><span class="line">        <span class="built_in">assert_eq!</span>(<span class="number">2</span> + <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We won’t use this test code at all, so go ahead and delete it.</p>
<h3 id="lets-write-some-rust"><a class="markdownIt-Anchor" href="#lets-write-some-rust">#</a> Let’s write some Rust</h3>
<p>Let’s put this code into  <code>src/lib.rs</code>  instead:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> wasm_bindgen::prelude::*;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[wasm_bindgen]</span></span><br><span class="line"><span class="keyword">extern</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alert</span></span>(s: &amp;<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[wasm_bindgen]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">greet</span></span>(name: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    alert(&amp;<span class="built_in">format!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is the contents of our Rust project. It has three main parts; let’s talk about each of them in turn. We give a high-level explanation here, and gloss over some details; to learn more about Rust, please check the free online book <span class="exturl" data-url="aHR0cHM6Ly9kb2MucnVzdC1sYW5nLm9yZy9ib29rLw==">The Rust Programming Language</span>.</p>
<h4 id="using-wasm-bindgen-to-communicate-between-rust-and-javascript"><a class="markdownIt-Anchor" href="#using-wasm-bindgen-to-communicate-between-rust-and-javascript">#</a> Using  <code>wasm-bindgen</code>  to communicate between Rust and JavaScript</h4>
<p>The first part looks like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> wasm_bindgen::prelude::*;</span><br></pre></td></tr></table></figure>
<p>Libraries are called “crates” in Rust.</p>
<p>Get it? <em>Cargo</em> ships <em>crates</em>.</p>
<p>The first line contains a  <code>use</code>  command, which imports code from a library into your code. In this case, we’re importing everything in the  <code>wasm_bindgen::prelude</code>  module. We use these features in the next section.</p>
<p>Before we move on to the next section, we should talk a bit more about  <code>wasm-bindgen</code> .</p>
<p><code>wasm-pack</code>  uses  <code>wasm-bindgen</code> , another tool, to provide a bridge between the types of JavaScript and Rust. It allows JavaScript to call a Rust API with a string, or a Rust function to catch a JavaScript exception.</p>
<p>We use  <code>wasm-bindgen</code> 's functionality in our package. In fact, that’s the next section.</p>
<h4 id="calling-external-functions-in-javascript-from-rust"><a class="markdownIt-Anchor" href="#calling-external-functions-in-javascript-from-rust">#</a> Calling external functions in JavaScript from Rust</h4>
<p>The next part looks like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[wasm_bindgen]</span></span><br><span class="line"><span class="keyword">extern</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">alert</span></span>(s: &amp;<span class="built_in">str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The bit inside the  <code>#[ ]</code>  is called an “attribute”, and it modifies the next statement somehow. In this case, that statement is an  <code>extern</code> , which tells Rust that we want to call some externally defined functions. The attribute says “wasm-bindgen knows how to find these functions”.</p>
<p>The third line is a function signature, written in Rust. It says “the  <code>alert</code>  function takes one argument, a string named  <code>s</code> .”</p>
<p>As you might suspect, this is <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/alert">the  <code>alert</code>  function provided by JavaScript</a>. We call this function in the next section.</p>
<p>Whenever you want to call JavaScript functions, you can add them to this file, and  <code>wasm-bindgen</code>  takes care of setting everything up for you. Not everything is supported yet, but we’re working on it. Please <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3J1c3R3YXNtL3dhc20tYmluZGdlbi9pc3N1ZXMvbmV3">file bugs</span> if something is missing.</p>
<h4 id="producing-rust-functions-that-javascript-can-call"><a class="markdownIt-Anchor" href="#producing-rust-functions-that-javascript-can-call">#</a> Producing Rust functions that JavaScript can call</h4>
<p>The final part is this one:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[wasm_bindgen]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">greet</span></span>(name: &amp;<span class="built_in">str</span>) &#123;</span><br><span class="line">    alert(&amp;<span class="built_in">format!</span>(<span class="string">&quot;Hello, &#123;&#125;!&quot;</span>, name));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Once again, we see the  <code>#[wasm_bindgen]</code>  attribute. In this case, it’s not modifying an  <code>extern</code>  block, but a  <code>fn</code> ; this means that we want this Rust function to be able to be called by JavaScript. It’s the opposite of  <code>extern</code> : these aren’t the functions we need, but rather the functions we’re giving out to the world.</p>
<p>This function is named  <code>greet</code> , and takes one argument, a string (written  <code>&amp;str</code> ),  <code>name</code> . It then calls the  <code>alert</code>  function we asked for in the  <code>extern</code>  block above. It passes a call to the  <code>format!</code>  macro, which lets us concatenate strings.</p>
<p>The  <code>format!</code>  macro takes two arguments in this case, a format string, and a variable to put in it. The format string is the  <code>&quot;Hello, &#123;&#125;!&quot;</code>  bit. It contains  <code>&#123;&#125;</code> s, where variables will be interpolated. The variable we’re passing is  <code>name</code> , the argument to the function, so if we call  <code>greet(&quot;Steve&quot;)</code>  we should see  <code>&quot;Hello, Steve!&quot;.</code></p>
<p>This is passed to  <code>alert()</code> , so when we call this function we will see an alert box with “Hello, Steve!” in it.</p>
<p>Now that our library is written, let’s build it.</p>
<h3 id="compiling-our-code-to-webassembly"><a class="markdownIt-Anchor" href="#compiling-our-code-to-webassembly">#</a> Compiling our code to WebAssembly</h3>
<p>To compile our code correctly, we first need to configure it with  <code>Cargo.toml</code> . Open this file, and change its contents to look like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[package]</span><br><span class="line">name = <span class="string">&quot;hello-wasm&quot;</span></span><br><span class="line">version = <span class="string">&quot;0.1.0&quot;</span></span><br><span class="line">authors = [<span class="string">&quot;Your Name &lt;you@example.com&gt;&quot;</span>]</span><br><span class="line">description = <span class="string">&quot;A sample project with wasm-pack&quot;</span></span><br><span class="line">license = <span class="string">&quot;MIT/Apache-2.0&quot;</span></span><br><span class="line">repository = <span class="string">&quot;https://github.com/yourgithubusername/hello-wasm&quot;</span></span><br><span class="line">edition = <span class="string">&quot;2018&quot;</span></span><br><span class="line"></span><br><span class="line">[lib]</span><br><span class="line">crate-type = [&quot;cdylib&quot;]</span><br><span class="line"></span><br><span class="line">[dependencies]</span><br><span class="line">wasm-bindgen = <span class="string">&quot;0.2&quot;</span></span><br></pre></td></tr></table></figure>
<p>Fill in your own repository and use the same info that  <code>git</code>  uses for the  <code>authors</code>  field.</p>
<p>The big part to add is the  <code>[package]</code> . The  <code>[lib]</code>  part tells Rust to build a  <code>cdylib</code>  version of our package; we won’t get into what that means in this tutorial. For more, consult the <span class="exturl" data-url="aHR0cHM6Ly9kb2MucnVzdC1sYW5nLm9yZy9jYXJnby9ndWlkZS8=">Cargo</span> and <span class="exturl" data-url="aHR0cHM6Ly9kb2MucnVzdC1sYW5nLm9yZy9yZWZlcmVuY2UvbGlua2FnZS5odG1s">Rust Linkage</span> documentation.</p>
<p>The last section is the  <code>[dependencies]</code>  section. Here’s where we tell Cargo what version of  <code>wasm-bindgen</code>  we want to depend on; in this case, that’s any  <code>0.2.z</code>  version (but not  <code>0.3.0</code>  or above).</p>
<h3 id="building-the-package"><a class="markdownIt-Anchor" href="#building-the-package">#</a> Building the package</h3>
<p>Now that we’ve got everything set up, let’s build the package. Type this into your terminal:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wasm-pack build --target web</span></span><br></pre></td></tr></table></figure>
<p>This does a number of things (and they take a lot of time, especially the first time you run  <code>wasm-pack</code> ). To learn about them in detail, check out <span class="exturl" data-url="aHR0cHM6Ly9oYWNrcy5tb3ppbGxhLm9yZy8yMDE4LzA0L2hlbGxvLXdhc20tcGFjay8=">this blog post on Mozilla Hacks</span>. In short,  <code>wasm-pack build</code> :</p>
<ol>
<li>Compiles your Rust code to WebAssembly.</li>
<li>Runs  <code>wasm-bindgen</code>  on that WebAssembly, generating a JavaScript file that wraps up that WebAssembly file into a module the browser can understand.</li>
<li>Creates a  <code>pkg</code>  directory and move that JavaScript file and your WebAssembly code into it.</li>
<li>Reads your  <code>Cargo.toml</code>  and produces an equivalent  <code>package.json</code> .</li>
<li>Copies your  <code>README.md</code>  (if you have one) into the package.</li>
</ol>
<p>The end result? You have a package inside of the  <code>pkg</code>  directory.</p>
<h4 id="a-digression-about-code-size"><a class="markdownIt-Anchor" href="#a-digression-about-code-size">#</a> A digression about code size</h4>
<p>If you check out the generated WebAssembly code size, it may be a few hundred kilobytes. We haven’t instructed Rust to optimize for size at all, and doing so cuts down on the size <em>a lot</em>. This is beyond the scope of this tutorial, but if you’d like to learn more, check out the Rust WebAssembly Working Group’s documentation on <span class="exturl" data-url="aHR0cHM6Ly9ydXN0d2FzbS5naXRodWIuaW8vYm9vay9nYW1lLW9mLWxpZmUvY29kZS1zaXplLmh0bWwjc2hyaW5raW5nLXdhc20tc2l6ZQ==">Shrinking .wasm Size</span>.</p>
<h2 id="using-the-package-on-the-web"><a class="markdownIt-Anchor" href="#using-the-package-on-the-web">#</a> Using the package on the web</h2>
<p>Now that we’ve got a compiled wasm module. let’s run it in the browser.</p>
<p>Let’s start by creating a file named  <code>index.html</code>  in the root of the project, and give it the following contents:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello-wasm example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;module&quot;</span>&gt;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">import</span> init, &#123; greet &#125; <span class="keyword">from</span> <span class="string">&quot;./pkg/hello_wasm.js&quot;</span>;</span></span><br><span class="line"><span class="javascript">            init().then(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">                greet(<span class="string">&quot;WebAssembly&quot;</span>);</span></span><br><span class="line">            &#125;);</span><br><span class="line">        <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The script in this file will import the js glue code, initialize the wasm module, and call the  <code>greet</code>  function we wrote in rust.</p>
<p>Serve the root directory of the project with a local web server, (e.g.  <code>python3 -m http.server</code> ). If you’re not sure how to do that, refer to <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9MZWFybi9Db21tb25fcXVlc3Rpb25zL3NldF91cF9hX2xvY2FsX3Rlc3Rpbmdfc2VydmVyI3J1bm5pbmdfYV9zaW1wbGVfbG9jYWxfaHR0cF9zZXJ2ZXI=">Running a simple local HTTP server</span>.</p>
<p>Load  <code>index.html</code>  from the web server (if you used the python3 example: <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDAwLw==">http://localhost:8000</span>). An alert box appears on the screen, with  <code>Hello, WebAssembly!</code>  in it. We’ve successfully called from JavaScript into Rust, and from Rust into JavaScript.</p>
<h2 id="making-our-package-available-to-npm"><a class="markdownIt-Anchor" href="#making-our-package-available-to-npm">#</a> Making our package available to npm</h2>
<p>If you want to use the WebAssembly module with npm, we’ll need to make a few changes.</p>
<p>Let’s start by recompiling out Rust with the target bundler option:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wasm-pack build --target bundler</span></span><br></pre></td></tr></table></figure>
<h3 id="install-nodejs-and-npm"><a class="markdownIt-Anchor" href="#install-nodejs-and-npm">#</a> Install Node.js and npm</h3>
<p>We are building an npm package, so you need to have Node.js and npm installed.</p>
<p>To get Node.js and npm, go to the <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL2dldC1ucG0=">Get npm!</span> page and follow the instructions. When it comes to picking a version, choose any one you’d like; this tutorial isn’t version-specific.</p>
<p>Next, let’s use  <code>npm link</code>  to make this package available to other JavaScript packages installed</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> pkg</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm link</span></span><br></pre></td></tr></table></figure>
<p>We now have an npm package, written in Rust, but compiled to WebAssembly. It’s ready for use from JavaScript, and doesn’t require the user to have Rust installed; the code included was the WebAssembly code, not the Rust source.</p>
<h3 id="using-the-npm-package-on-the-web"><a class="markdownIt-Anchor" href="#using-the-npm-package-on-the-web">#</a> Using the npm package on the web</h3>
<p>Let’s build a website that uses our new npm package. Many people use npm packages through various bundler tools, and we’ll be using one of them,  <code>webpack</code> , in this tutorial. It’s only a little bit complex, and shows a realistic use-case.</p>
<p>Let’s move back out of the  <code>pkg</code>  directory, and make a new directory,  <code>site</code> , to try this out in:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir site</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> site</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm link hello-wasm</span></span><br></pre></td></tr></table></figure>
<p>Create a new file,  <code>package.json</code> , and put the following code in it:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;serve&quot;</span>: <span class="string">&quot;webpack-dev-server&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hello-wasm&quot;</span>: <span class="string">&quot;^0.1.0&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;webpack&quot;</span>: <span class="string">&quot;^4.25.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;webpack-cli&quot;</span>: <span class="string">&quot;^3.1.2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;webpack-dev-server&quot;</span>: <span class="string">&quot;^3.1.10&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, we need to configure Webpack. Create  <code>webpack.config.js</code>  and put the following in it:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: <span class="string">&quot;./index.js&quot;</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">&quot;dist&quot;</span>),</span><br><span class="line">        filename: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">&quot;development&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Next, create a file named  <code>index.js</code> , and give it these contents:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">&quot;./node_modules/hello-wasm/hello_wasm.js&quot;</span>).then(<span class="function">(<span class="params">js</span>) =&gt;</span> &#123;</span><br><span class="line">    js.greet(<span class="string">&quot;WebAssembly with NPM&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>This imports the new module from the  <code>node_modules</code>  folder. This isn’t considered a best practice, but this is a demo, so it’s OK for now. Once it’s loaded, it calls the  <code>greet</code>  function from that module, passing  <code>&quot;WebAssembly&quot;</code>  as a string. Note how there’s nothing special here, yet we’re calling into Rust code. As far as the JavaScript code can tell, this is just a normal module.</p>
<p>Finally, we need to modify the HTML file; open the  <code>index.html</code>  file and replace the current contents with the following:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello-wasm example<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>We’re done making files. Let’s give this a shot:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm run serve</span></span><br></pre></td></tr></table></figure>
<p>This starts a web server. Load <span class="exturl" data-url="aHR0cDovL2xvY2FsaG9zdDo4MDgwLw==">http://localhost:8080</span> and an alert box appears on the screen, with  <code>Hello, WebAssembly with NPM!</code>  in it. We’ve successfully used the Rust module with npm.</p>
<h2 id="conclusion"><a class="markdownIt-Anchor" href="#conclusion">#</a> Conclusion</h2>
<p>This is the end of our tutorial; we hope you’ve found it useful.</p>
<p>There’s lots of exciting work going on in this space; if you’d like to help make it even better, check out <span class="exturl" data-url="aHR0cHM6Ly9maXR6Z2VyYWxkbmljay5jb20vMjAxOC8wMi8yNy93YXNtLWRvbWFpbi13b3JraW5nLWdyb3VwLmh0bWw=">the Rust WebAssembly Working Group</span>.</p>

      <div class="tags">
          <a href="/tags/js/" rel="tag"><i class="ic i-tag"></i> js</a>
          <a href="/tags/rust/" rel="tag"><i class="ic i-tag"></i> rust</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2021-10-18 13:27:20" itemprop="dateModified" datetime="2021-10-18T13:27:20+08:00">2021-10-18</time>
  </span>
</div>

      

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2021/08/04/oralce-plsql-java/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliwyw55j20zk0m8hdt.jpg" title="Calling Java from PL&#x2F;SQL">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Calling Java from PL/SQL</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2021/08/07/css-variables/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeu7txpzj20zk0m81kx.jpg" title="CSS Variables">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>CSS Variables</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rust-and-webassembly-use-cases"><span class="toc-number">1.</span> <span class="toc-text"> Rust and WebAssembly use cases</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rust-environment-setup"><span class="toc-number">2.</span> <span class="toc-text"> Rust Environment Setup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#install-rust"><span class="toc-number">2.1.</span> <span class="toc-text"> Install Rust</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wasm-pack"><span class="toc-number">2.2.</span> <span class="toc-text"> wasm-pack</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#building-our-webassembly-package"><span class="toc-number">3.</span> <span class="toc-text"> Building our WebAssembly package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lets-write-some-rust"><span class="toc-number">3.1.</span> <span class="toc-text"> Let’s write some Rust</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#using-wasm-bindgen-to-communicate-between-rust-and-javascript"><span class="toc-number">3.1.1.</span> <span class="toc-text"> Using  wasm-bindgen  to communicate between Rust and JavaScript</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#calling-external-functions-in-javascript-from-rust"><span class="toc-number">3.1.2.</span> <span class="toc-text"> Calling external functions in JavaScript from Rust</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#producing-rust-functions-that-javascript-can-call"><span class="toc-number">3.1.3.</span> <span class="toc-text"> Producing Rust functions that JavaScript can call</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compiling-our-code-to-webassembly"><span class="toc-number">3.2.</span> <span class="toc-text"> Compiling our code to WebAssembly</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#building-the-package"><span class="toc-number">3.3.</span> <span class="toc-text"> Building the package</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a-digression-about-code-size"><span class="toc-number">3.3.1.</span> <span class="toc-text"> A digression about code size</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#using-the-package-on-the-web"><span class="toc-number">4.</span> <span class="toc-text"> Using the package on the web</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#making-our-package-available-to-npm"><span class="toc-number">5.</span> <span class="toc-text"> Making our package available to npm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#install-nodejs-and-npm"><span class="toc-number">5.1.</span> <span class="toc-text"> Install Node.js and npm</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#using-the-npm-package-on-the-web"><span class="toc-number">5.2.</span> <span class="toc-text"> Using the npm package on the web</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#conclusion"><span class="toc-number">6.</span> <span class="toc-text"> Conclusion</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="江边鸟"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">江边鸟</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">278</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">2</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">39</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xoY2hlbjc0" title="https:&#x2F;&#x2F;github.com&#x2F;lhchen74"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;"><i class="ic i-cloud-music"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2021/08/04/oralce-plsql-java/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2021/08/07/css-variables/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">江边鸟 @ 露の世</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2021/08/07/rust-webassembly/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
