



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="露の世" href="https://lhchen74.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="露の世" href="https://lhchen74.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="露の世" href="https://lhchen74.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="js" />


<link rel="canonical" href="https://lhchen74.github.io/2021/10/09/javascript-mutation-observer/">



  <title>
Mutation observer |
D E W = 露の世</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Mutation observer
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2021-10-09 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2021-10-09T00:00:00+08:00">2021-10-09</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">D E W</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipesrnqv3j20zk0m8ava.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicit4jrvuj20zk0m8785.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeuv80yoj20zk0m8kjl.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giph4fomxoj20zk0m8axp.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://lhchen74.github.io/2021/10/09/javascript-mutation-observer/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="江边鸟">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="露の世">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>转载：<span class="exturl" data-url="aHR0cHM6Ly9qYXZhc2NyaXB0LmluZm8vbXV0YXRpb24tb2JzZXJ2ZXI=">Mutation observer - javascript.info</span></p>
</blockquote>
<p><code>MutationObserver</code>  is a built-in object that observes a DOM element and fires a callback when it detects a change.</p>
<p>We’ll first take a look at the syntax, and then explore a real-world use case, to see where such thing may be useful.</p>
<h2 id="syntax"><a class="markdownIt-Anchor" href="#syntax">#</a> Syntax</h2>
<p><code>MutationObserver</code>  is easy to use.</p>
<p>First, we create an observer with a callback-function:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(callback);</span><br></pre></td></tr></table></figure>
<p>And then attach it to a DOM node:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">observer.observe(node, config);</span><br></pre></td></tr></table></figure>
<p><code>config</code>  is an object with boolean options “what kind of changes to react on”:</p>
<ul>
<li><code>childList</code>  - changes in the direct children of  <code>node</code> ,</li>
<li><code>subtree</code>  - in all descendants of  <code>node</code> ,</li>
<li><code>attributes</code>  - attributes of  <code>node</code> ,</li>
<li><code>attributeFilter</code>  - an array of attribute names, to observe only selected ones.</li>
<li><code>characterData</code>  - whether to observe  <code>node.data</code>  (text content),</li>
</ul>
<p>Few other options:</p>
<ul>
<li><code>attributeOldValue</code>  - if  <code>true</code> , pass both the old and the new value of attribute to callback (see below), otherwise only the new one (needs  <code>attributes</code>  option),</li>
<li><code>characterDataOldValue</code>  - if  <code>true</code> , pass both the old and the new value of  <code>node.data</code>  to callback (see below), otherwise only the new one (needs  <code>characterData</code>  option).</li>
</ul>
<p>Then after any changes, the  <code>callback</code>  is executed: changes are passed in the first argument as a list of <span class="exturl" data-url="aHR0cHM6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbnJlY29yZA==">MutationRecord</span> objects, and the observer itself as the second argument.</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbnJlY29yZA==">MutationRecord</span> objects have properties:</p>
<ul>
<li>
<p>type mutation type, one of</p>
<ul>
<li><code>&quot;attributes&quot;</code> : attribute modified</li>
<li><code>&quot;characterData&quot;</code> : data modified, used for text nodes,</li>
<li><code>&quot;childList&quot;</code> : child elements added/removed,</li>
</ul>
</li>
<li>
<p><code>target</code>  - where the change occurred: an element for  <code>&quot;attributes&quot;</code> , or text node for  <code>&quot;characterData&quot;</code> , or an element for a  <code>&quot;childList&quot;</code>  mutation,</p>
</li>
<li>
<p><code>addedNodes/removedNodes</code>  - nodes that were added/removed,</p>
</li>
<li>
<p><code>previousSibling/nextSibling</code>  - the previous and next sibling to added/removed nodes,</p>
</li>
<li>
<p><code>attributeName/attributeNamespace</code>  - the name/namespace (for XML) of the changed attribute,</p>
</li>
<li>
<p><code>oldValue</code>  - the previous value, only for attribute or text changes, if the corresponding option is set  <code>attributeOldValue</code> / <code>characterDataOldValue</code> .</p>
</li>
</ul>
<p>For example, here’s a  <code>&lt;div&gt;</code>  with a  <code>contentEditable</code>  attribute. That attribute allows us to focus on it and edit.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">contenteditable</span> <span class="attr">id</span>=<span class="string">&quot;elem&quot;</span>&gt;</span>Click and <span class="tag">&lt;<span class="name">b</span>&gt;</span>edit<span class="tag">&lt;/<span class="name">b</span>&gt;</span>, please<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutationRecords</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(mutationRecords); <span class="comment">// console.log(the changes)</span></span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="comment">// observe everything except attributes</span></span></span><br><span class="line">    observer.observe(elem, &#123;</span><br><span class="line"><span class="javascript">        childList: <span class="literal">true</span>, <span class="comment">// observe direct children</span></span></span><br><span class="line"><span class="javascript">        subtree: <span class="literal">true</span>, <span class="comment">// and lower descendants too</span></span></span><br><span class="line"><span class="javascript">        characterDataOldValue: <span class="literal">true</span>, <span class="comment">// pass old data to callback</span></span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>If we run this code in the browser, then focus on the given  <code>&lt;div&gt;</code>  and change the text inside  <code>&lt;b&gt;edit&lt;/b&gt;</code> ,  <code>console.log</code>  will show one mutation:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mutationRecords = [&#123;</span><br><span class="line">  type: <span class="string">&quot;characterData&quot;</span>,</span><br><span class="line">  oldValue: <span class="string">&quot;edit&quot;</span>,</span><br><span class="line">  target: <span class="xml"><span class="tag">&lt;<span class="name">text</span> <span class="attr">node</span>&gt;</span>,</span></span><br><span class="line"><span class="xml">  // other properties empty</span></span><br><span class="line"><span class="xml">&#125;];</span></span><br></pre></td></tr></table></figure>
<p>If we make more complex editing operations, e.g. remove the  <code>&lt;b&gt;edit&lt;/b&gt;</code> , the mutation event may contain multiple mutation records:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mutationRecords = [&#123;</span><br><span class="line">  type: <span class="string">&quot;childList&quot;</span>,</span><br><span class="line">  target: <span class="xml">&lt;div#elem&gt;,</span></span><br><span class="line">  removedNodes: [&lt;b&gt;],</span><br><span class="line">  nextSibling: &lt;text node&gt;,</span><br><span class="line">  previousSibling: &lt;text node&gt;</span><br><span class="line">  // other properties empty</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  type: &quot;characterData&quot;</span><br><span class="line">  target: &lt;text node&gt;</span><br><span class="line">  // ...mutation details depend on how the browser handles such removal</span><br><span class="line">  // it may coalesce two adjacent text nodes &quot;edit &quot; and &quot;, please&quot; into one node</span><br><span class="line">  // or it may leave them separate text nodes</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>So,  <code>MutationObserver</code>  allows to react on any changes within DOM subtree.</p>
<h2 id="usage-for-integration"><a class="markdownIt-Anchor" href="#usage-for-integration">#</a> Usage for integration</h2>
<p>When such thing may be useful?</p>
<p>Imagine the situation when you need to add a third-party script that contains useful functionality, but also does something unwanted, e.g. shows ads  <code>&lt;div class=&quot;ads&quot;&gt;Unwanted ads&lt;/div&gt;</code> .</p>
<p>Naturally, the third-party script provides no mechanisms to remove it.</p>
<p>Using  <code>MutationObserver</code> , we can detect when the unwanted element appears in our DOM and remove it.</p>
<p>There are other situations when a third-party script adds something into our document, and we’d like to detect, when it happens, to adapt our page, dynamically resize something etc.</p>
<p><code>MutationObserver</code>  allows to implement this.</p>
<h2 id="usage-for-architecture"><a class="markdownIt-Anchor" href="#usage-for-architecture">#</a> Usage for architecture</h2>
<p>There are also situations when  <code>MutationObserver</code>  is good from architectural standpoint.</p>
<p>Let’s say we’re making a website about programming. Naturally, articles and other materials may contain source code snippets.</p>
<p>Such snippet in an HTML markup looks like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;pre class&#x3D;&quot;language-javascript&quot;&gt;&lt;code&gt;</span><br><span class="line">  &#x2F;&#x2F; here&#39;s the code</span><br><span class="line">  let hello &#x3D; &quot;world&quot;;</span><br><span class="line">&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>For better readability and at the same time, to beautify it, we’ll be using a JavaScript syntax highlighting library on our site, like <span class="exturl" data-url="aHR0cHM6Ly9wcmlzbWpzLmNvbS8=">Prism.js</span>. To get syntax highlighting for above snippet in Prism,  <code>Prism.highlightElem(pre)</code>  is called, which examines the contents of such  <code>pre</code>  elements and adds special tags and styles for colored syntax highlighting into those elements, similar to what you see in examples here, on this page.</p>
<p>When exactly should we run that highlighting method? Well, we can do it on  <code>DOMContentLoaded</code>  event, or put the script at the bottom of the page. The moment our DOM is ready, we can search for elements  <code>pre[class*=&quot;language&quot;]</code>  and call  <code>Prism.highlightElem</code>  on them:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// highlight all code snippets on the page</span></span><br><span class="line"><span class="built_in">document</span></span><br><span class="line">    .querySelectorAll(<span class="string">&#x27;pre[class*=&quot;language&quot;]&#x27;</span>)</span><br><span class="line">    .forEach(Prism.highlightElem);</span><br></pre></td></tr></table></figure>
<p>Everything’s simple so far, right? We find code snippets in HTML and highlight them.</p>
<p>Now let’s go on. Let’s say we’re going to dynamically fetch materials from a server. We’ll study methods for that <span class="exturl" data-url="aHR0cHM6Ly9qYXZhc2NyaXB0LmluZm8vZmV0Y2g=">later in the tutorial</span>. For now it only matters that we fetch an HTML article from a webserver and display it on demand:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> article =</span><br><span class="line">    <span class="comment">/* fetch new content from server */</span></span><br><span class="line">    (articleElem.innerHTML = article);</span><br></pre></td></tr></table></figure>
<p>The new  <code>article</code>  HTML may contain code snippets. We need to call  <code>Prism.highlightElem</code>  on them, otherwise they won’t get highlighted.</p>
<p><strong>Where and when to call Prism.highlightElem for a dynamically loaded article?</strong></p>
<p>We could append that call to the code that loads an article, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> article =</span><br><span class="line">    <span class="comment">/* fetch new content from server */</span></span><br><span class="line">    (articleElem.innerHTML = article);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> snippets = articleElem.querySelectorAll(<span class="string">&#x27;pre[class*=&quot;language-&quot;]&#x27;</span>);</span><br><span class="line">snippets.forEach(Prism.highlightElem);</span><br></pre></td></tr></table></figure>
<p>…But, imagine if we have many places in the code where we load our content - articles, quizzes, forum posts, etc. Do we need to put the highlighting call everywhere, to highlight the code in content after loading? That’s not very convenient.</p>
<p>And what if the content is loaded by a third-party module? For example, we have a forum written by someone else, that loads content dynamically, and we’d like to add syntax highlighting to it. No one likes patching third-party scripts.</p>
<p>Luckily, there’s another option.</p>
<p>We can use  <code>MutationObserver</code>  to automatically detect when code snippets are inserted into the page and highlight them.</p>
<p>So we’ll handle the highlighting functionality in one place, relieving us from the need to integrate it.</p>
<h3 id="dynamic-highlight-demo"><a class="markdownIt-Anchor" href="#dynamic-highlight-demo">#</a> Dynamic highlight demo</h3>
<p>Here’s the working example.</p>
<p>If you run this code, it starts observing the element below and highlighting any code snippets that appear there:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> MutationObserver(<span class="function">(<span class="params">mutations</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> mutation <span class="keyword">of</span> mutations) &#123;</span><br><span class="line">        <span class="comment">// examine new nodes, is there anything to highlight?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> node <span class="keyword">of</span> mutation.addedNodes) &#123;</span><br><span class="line">            <span class="comment">// we track only elements, skip other nodes (e.g. text nodes)</span></span><br><span class="line">            <span class="keyword">if</span> (!(node <span class="keyword">instanceof</span> HTMLElement)) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// check the inserted element for being a code snippet</span></span><br><span class="line">            <span class="keyword">if</span> (node.matches(<span class="string">&#x27;pre[class*=&quot;language-&quot;]&#x27;</span>)) &#123;</span><br><span class="line">                Prism.highlightElement(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// or maybe there&#x27;s a code snippet somewhere in its subtree?</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> elem <span class="keyword">of</span> node.querySelectorAll(<span class="string">&#x27;pre[class*=&quot;language-&quot;]&#x27;</span>)) &#123;</span><br><span class="line">                Prism.highlightElement(elem);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> demoElem = <span class="built_in">document</span>.getElementById(<span class="string">&quot;highlight-demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">observer.observe(demoElem, &#123; <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">subtree</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure>
<p>Here, below, there’s an HTML-element and JavaScript that dynamically fills it using  <code>innerHTML</code> .</p>
<p>Please run the previous code (above, observes that element), and then the code below. You’ll see how  <code>MutationObserver</code>  detects and highlights the snippet.</p>
<p>A demo-element with  <code>id=&quot;highlight-demo&quot;</code> , run the code above to observe it.</p>
<p>The following code populates its  <code>innerHTML</code> , that causes the  <code>MutationObserver</code>  to react and highlight its contents:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> demoElem = <span class="built_in">document</span>.getElementById(<span class="string">&quot;highlight-demo&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// dynamically insert content with code snippets</span></span><br><span class="line">demoElem.innerHTML = <span class="string">`A code snippet is below:</span></span><br><span class="line"><span class="string">  &lt;pre class=&quot;language-javascript&quot;&gt;&lt;code&gt; let hello = &quot;world!&quot;; &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;Another one:&lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;div&gt;</span></span><br><span class="line"><span class="string">    &lt;pre class=&quot;language-css&quot;&gt;&lt;code&gt;.class &#123; margin: 5px; &#125; &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">`</span>;</span><br></pre></td></tr></table></figure>
<p>Now we have  <code>MutationObserver</code>  that can track all highlighting in observed elements or the whole  <code>document</code> . We can add/remove code snippets in HTML without thinking about it.</p>
<h2 id="additional-methods"><a class="markdownIt-Anchor" href="#additional-methods">#</a> Additional methods</h2>
<p>There’s a method to stop observing the node:</p>
<ul>
<li><code>observer.disconnect()</code>  - stops the observation.</li>
</ul>
<p>When we stop the observing, it might be possible that some changes were not yet processed by the observer. In such cases, we use</p>
<ul>
<li><code>observer.takeRecords()</code>  - gets a list of unprocessed mutation records - those that happened, but the callback has not handled them.</li>
</ul>
<p>These methods can be used together, like this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get a list of unprocessed mutations</span></span><br><span class="line"><span class="comment">// should be called before disconnecting,</span></span><br><span class="line"><span class="comment">// if you care about possibly unhandled recent mutations</span></span><br><span class="line"><span class="keyword">let</span> mutationRecords = observer.takeRecords();</span><br><span class="line"></span><br><span class="line"><span class="comment">// stop tracking changes</span></span><br><span class="line">observer.disconnect();</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>Records returned by  <code>observer.takeRecords()</code>  are removed from the processing queue</strong></p>
<p>The callback won’t be called for records, returned by  <code>observer.takeRecords()</code> .</p>
<p><strong>Garbage collection interaction</strong></p>
<p>Observers use weak references to nodes internally. That is, if a node is removed from the DOM, and becomes unreachable, then it can be garbage collected.</p>
<p>The mere fact that a DOM node is observed doesn’t prevent the garbage collection.</p>
<h2 id="summary"><a class="markdownIt-Anchor" href="#summary">#</a> Summary</h2>
<p><code>MutationObserver</code>  can react to changes in DOM - attributes, text content and adding/removing elements.</p>
<p>We can use it to track changes introduced by other parts of our code, as well as to integrate with third-party scripts.</p>
<p><code>MutationObserver</code>  can track any changes. The config “what to observe” options are used for optimizations, not to spend resources on unneeded callback invocations.</p>

      <div class="tags">
          <a href="/tags/js/" rel="tag"><i class="ic i-tag"></i> js</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2021-10-20 15:08:27" itemprop="dateModified" datetime="2021-10-20T15:08:27+08:00">2021-10-20</time>
  </span>
</div>

      

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2021/09/28/latex/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipeuibk9fj20zk0m8ay2.jpg" title="Latex">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Latex</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2021/10/11/time-zone/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclx29mstj20zk0m8hdt.jpg" title="How to Write Time Zones Correctly">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>How to Write Time Zones Correctly</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#syntax"><span class="toc-number">1.</span> <span class="toc-text"> Syntax</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usage-for-integration"><span class="toc-number">2.</span> <span class="toc-text"> Usage for integration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usage-for-architecture"><span class="toc-number">3.</span> <span class="toc-text"> Usage for architecture</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dynamic-highlight-demo"><span class="toc-number">3.1.</span> <span class="toc-text"> Dynamic highlight demo</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#additional-methods"><span class="toc-number">4.</span> <span class="toc-text"> Additional methods</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#summary"><span class="toc-number">5.</span> <span class="toc-text"> Summary</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="江边鸟"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">江边鸟</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">288</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">2</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">40</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xoY2hlbjc0" title="https:&#x2F;&#x2F;github.com&#x2F;lhchen74"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly9jb2RlcGVuLmlvL2xoY2hlbjc0" title="https:&#x2F;&#x2F;codepen.io&#x2F;lhchen74"><i class="ic i-address-card"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2021/09/28/latex/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2021/10/11/time-zone/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">江边鸟 @ D E W</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2021/10/09/javascript-mutation-observer/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
