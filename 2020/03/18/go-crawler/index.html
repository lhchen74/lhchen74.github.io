



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="露の世" href="https://lhchen74.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="露の世" href="https://lhchen74.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="露の世" href="https://lhchen74.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="go" />


<link rel="canonical" href="https://lhchen74.github.io/2020/03/18/go-crawler/">



  <title>
Build a Web Crawler in Go |
D E W = 露の世</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Build a Web Crawler in Go
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2020-03-18 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2020-03-18T00:00:00+08:00">2020-03-18</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">D E W</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeu1usa7j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicliierfjj20zk0m8npd.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipewr8iypj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclhpw3lwj20zk0m8gvw.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://lhchen74.github.io/2020/03/18/go-crawler/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="江边鸟">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="露の世">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>转载：<span class="exturl" data-url="aHR0cHM6Ly9qZGFuZ2VyLmNvbS9idWlsZC1hLXdlYi1jcmF3bGVyLWluLWdvLmh0bWw=">Build a Web Crawler in Go</span></p>
</blockquote>
<p>One of the basic tests I use to try out a new programming language is building a web crawler. I stole the idea from my colleague <span class="exturl" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9NaWtlTGV3aXM=">Mike Lewis</span> and I love it because it uses all the principles necessary in internet engineering: A web crawler needs to parse semi-structured text, rely on 3rd-party APIs, manage its internal state, and perform some basic concurrency.</p>
<h2 id="starting-a-new-project-with-go"><a class="markdownIt-Anchor" href="#starting-a-new-project-with-go">#</a> Starting a new project with Go</h2>
<p>This is a tutorial that is accessible for complete beginners to the Go programming language or to web programming. All the commands you need to run are provided and all the code you need to type into the  <code>.go</code>  source code files is shown to you a piece at a time. Each time I introduce a new concept you’ll need to edit the same file, slowly building up functionality. When you run each version of the code Go will give you an exact error message with a line number so you’ll be able to fix any mistakes you make. If you get totally lost you can just copy straight out of the page into a new file and pick back up. If you’re new to Go I <em>highly</em> recommend reading the excellent <span class="exturl" data-url="aHR0cDovL2dvbGFuZy5vcmcvZG9jLw==">Go documentation</span> to help you make sense of what’s on this page.</p>
<p>Since this example requires the Go programming language you should start by installing Go:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install golang  <span class="comment"># (if you&#x27;re on Linux)</span></span><br><span class="line">brew install go  <span class="comment"># (if you&#x27;re on a Mac)</span></span><br></pre></td></tr></table></figure>
<h2 id="creating-the-main-function"><a class="markdownIt-Anchor" href="#creating-the-main-function">#</a> Creating the ‘main’ function</h2>
<p>Go is so fast that it’s practically a scripting language. All you need to run it is a ‘main’ package and a ‘main’ function. On my machine the following tiny program takes only 0.04 seconds to compile. Let’s create a new file and try it out:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// Put this in a new file &#x27;crawl.go&#x27;</span></span><br><span class="line"><span class="keyword">package</span> main     <span class="comment">// This is technically a perfectly</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;&#125;    <span class="comment">// valid Go program, even if a bit boring</span></span><br></pre></td></tr></table></figure>
<p>Now you’re a Go programmer. Hooray! Let’s make it just slightly more interesting by turning this into a Hello World program.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main    <span class="comment">// package will always be &#x27;main&#x27; for our app.</span></span><br><span class="line"><span class="keyword">import</span> (        <span class="comment">// the &#x27;import&#x27; section is where you specify all</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span>         <span class="comment">// dependencies and &#x27;fmt&#x27; is the package used for</span></span><br><span class="line">)               <span class="comment">// printing to the screen.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;                   <span class="comment">// The &#x27;main&#x27; function is always the one that starts</span></span><br><span class="line">  fmt.Println(<span class="string">&quot;I&#x27;m a gopher!&quot;</span>)  <span class="comment">// your program</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And now let’s run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run crawl.go  <span class="comment"># run this in your terminal in whatever directory you created the file.</span></span><br></pre></td></tr></table></figure>
<p>You could have executed  <code>go build crawl.go</code>  instead of  <code>go run crawl.go</code>  and it would have just compiled the file for you. The “run” command both compiles and executes it so you’ll find it turns Go into a usable scripting language (indeed, it’s faster than a lot of Ruby or Python projects).</p>
<h2 id="whats-a-web-crawler"><a class="markdownIt-Anchor" href="#whats-a-web-crawler">#</a> What’s a web crawler?</h2>
<p>A web crawler is the portion of a search engine that scans web pages looking for links and then follows them. It would normally store the data it finds into some database where it can be useful but our version is just going to print the URLs to the screen and move along.</p>
<p>While not quite enterprise grade this’ll let us play with all the same concepts and see some really satisfying output as our little script wanders the web.</p>
<h2 id="step-1-starting-from-a-specific-page"><a class="markdownIt-Anchor" href="#step-1-starting-from-a-specific-page">#</a> Step 1. Starting from a specific page</h2>
<p>You’ve got to start crawling from somewhere and in our program we’ll let the person who executes the crawler specify what starting page to use. This involves reading a command line argument which, in most programming languages, will be stored in a variable named something like  <code>ARGV</code>  and Go is no exception.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;flag&quot;</span>        <span class="comment">// &#x27;flag&#x27; helps you parse command line arguments</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span>          <span class="comment">// &#x27;os&#x27; gives you access to system calls</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()         <span class="comment">// This stuff with &#x27;flag&#x27; converts the command line</span></span><br><span class="line">  args := flag.Args()  <span class="comment">// arguments to a new variable named &#x27;args&#x27;</span></span><br><span class="line">                       <span class="comment">// The &#x27;:=&#x27; form means &quot;this is a brand new variable&quot; and</span></span><br><span class="line">                       <span class="comment">// a &#x27;=&#x27; here would throw an error.</span></span><br><span class="line">                       <span class="comment">// At this point &#x27;args&#x27; will be either an empty list</span></span><br><span class="line">                       <span class="comment">// (if no command line arguments were provided) or it&#x27;ll</span></span><br><span class="line">                       <span class="comment">// contain some string values.</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)  <span class="comment">// if a starting page wasn&#x27;t provided as an argument</span></span><br><span class="line">    os.Exit(<span class="number">1</span>)                                <span class="comment">// show a message and exit.</span></span><br><span class="line">  &#125;                                           <span class="comment">// Note that &#x27;main&#x27; doesn&#x27;t return anything.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now run this file by typing  <code>go run crawl.go</code>  and see that it yells at you because you didn’t specify a starting web page. Then try running it with an argument provided ( <code>go run crawl.go http://news.google.com</code> ) and it won’t show that message anymore.</p>
<h2 id="step-2-retrieving-a-page-from-the-internet"><a class="markdownIt-Anchor" href="#step-2-retrieving-a-page-from-the-internet">#</a> Step 2. Retrieving a page from the internet</h2>
<p>The next thing you need is to download the page your starting URL represents so you can scan it for links. In Go there is a great http package right in the standard library. You can use the primitives Go gives you to turn your URL string into a string representing the page body.</p>
<p>First I’ll show you what this looks like in isolation, then we can incorporate it into our crawler. Put the following in retrieve.go:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: retrieve.go</span></span><br><span class="line"><span class="keyword">package</span> main    <span class="comment">// Note: this is a new temporary file, not our crawl.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span>    <span class="comment">// this is the &#x27;http&#x27; package we&#x27;ll be using to retrieve a page</span></span><br><span class="line">  <span class="string">&quot;io/ioutil&quot;</span>   <span class="comment">// we&#x27;ll only use &#x27;ioutil&#x27; to maek reading and printing</span></span><br><span class="line">)               <span class="comment">// the html page a little easier in this example.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  resp, err := http.Get(<span class="string">&quot;http://6brand.com.com&quot;</span>)  <span class="comment">// See how we assign two variables at once here?</span></span><br><span class="line">                                                  <span class="comment">// That destructuring is really common</span></span><br><span class="line">                                                  <span class="comment">// in Go. The way you handle errors in</span></span><br><span class="line">                                                  <span class="comment">// Go is to expect that functions you</span></span><br><span class="line">                                                  <span class="comment">// call will return two things and the</span></span><br><span class="line">                                                  <span class="comment">// second one will be an error. If the</span></span><br><span class="line">                                                  <span class="comment">// error is nil then you can continue</span></span><br><span class="line">                                                  <span class="comment">// but if it&#x27;s not you need to handle it.</span></span><br><span class="line">  fmt.Println(<span class="string">&quot;http transport error is:&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">  body, err := ioutil.ReadAll(resp.Body)  <span class="comment">// resp.Body isn&#x27;t a string, it&#x27;s more like a reference</span></span><br><span class="line">                                          <span class="comment">// to a stream of data. So we use the &#x27;ioutil&#x27;</span></span><br><span class="line">                                          <span class="comment">// package to read it into memory for us.</span></span><br><span class="line">  fmt.Println(<span class="string">&quot;read error is:&quot;</span>, err)</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="keyword">string</span>(body))   <span class="comment">// We cast the html body to a string because</span></span><br><span class="line">&#125;                             <span class="comment">// Go hands it to us as a byte array</span></span><br></pre></td></tr></table></figure>
<p>And run it with  <code>go run retrieve.go</code> . You should see the body of <span class="exturl" data-url="aHR0cDovLzZicmFuZC5jb20v">6brand.com</span> printed to your screen. And if you scroll up to the top you’ll see that there were no errors (literally, err was nil) in either the transporting or reading of your http call. Yay, go you.</p>
<p>Let’s copy the new pieces of this code into our  <code>crawl.go</code> :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;flag&quot;</span>          <span class="comment">// &#x27;flag&#x27;, &#x27;fmt&#x27; and &#x27;os&#x27; we&#x27;ll keep around</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span>      <span class="comment">// &#x27;http&#x27; will retrieve pages for us</span></span><br><span class="line">  <span class="string">&quot;io/ioutil&quot;</span>     <span class="comment">// &#x27;ioutil&#x27; will help us print pages to the screen</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  retrieve(args[<span class="number">0</span>])  <span class="comment">// The reason we can call &#x27;retrieve&#x27; is because</span></span><br><span class="line">                     <span class="comment">// it&#x27;s defined in the same package as the calling function.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">retrieve</span><span class="params">(uri <span class="keyword">string</span>)</span></span> &#123;  <span class="comment">// This func(tion) takes a parameter and the</span></span><br><span class="line">                             <span class="comment">// format for a function parameter definition is</span></span><br><span class="line">                             <span class="comment">// to say what the name of the parameter is and then</span></span><br><span class="line">                             <span class="comment">// the type.</span></span><br><span class="line">                             <span class="comment">// So here we&#x27;re expecting to be given a</span></span><br><span class="line">                             <span class="comment">// string that we&#x27;ll refer to as &#x27;uri&#x27;</span></span><br><span class="line">  resp, err := http.Get(uri)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;            <span class="comment">// This is the way error handling typically works in Go.</span></span><br><span class="line">    <span class="keyword">return</span>                   <span class="comment">// It&#x27;s a bit verbose but it works.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()  <span class="comment">// Important: we need to close the resource we opened</span></span><br><span class="line">                           <span class="comment">// (the TCP connection to some web server and our reference</span></span><br><span class="line">                           <span class="comment">// to the stream of data it sends us).</span></span><br><span class="line">                           <span class="comment">// `defer` delays an operation until the function ends.</span></span><br><span class="line">                           <span class="comment">// It&#x27;s basically the same as if you&#x27;d moved the code</span></span><br><span class="line">                           <span class="comment">// you&#x27;re deferring to the very last line of the func.</span></span><br><span class="line"></span><br><span class="line">  body, _ := ioutil.ReadAll(resp.Body)  <span class="comment">// I&#x27;m assigning the err to _ &#x27;cause</span></span><br><span class="line">                                        <span class="comment">// I don&#x27;t care about it but Go will whine</span></span><br><span class="line">  fmt.Println(<span class="keyword">string</span>(body))             <span class="comment">// if I name it and don&#x27;t use it</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>What we’ve got now is an excellent start to a web crawler. It’s able to boot, parse the URL you’ve given it, open a connection to the right remote host, and retrieve the html content.</p>
<h2 id="step-3-parsing-hyperlinks-from-html"><a class="markdownIt-Anchor" href="#step-3-parsing-hyperlinks-from-html">#</a> Step 3. Parsing hyperlinks from HTML</h2>
<p>If you have a page of HTML you may want to use a regular expression to extract the links. Don’t. Like, <span class="exturl" data-url="aHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8xNzMyMzQ4L3JlZ2V4LW1hdGNoLW9wZW4tdGFncy1leGNlcHQteGh0bWwtc2VsZi1jb250YWluZWQtdGFncy8xNzMyNDU0IzE3MzI0NTQ=">really don’t</span>. Regular expressions are not a good tool for that. The best way is, sadly, to walk through the tree structure of the page finding anchor tags and extracting  <code>href</code>  attributes from them. In most languages this is no fun but in Go’s standard library it’s extra not fun (though not nearly as painful as Java) and I won’t subject you to it here. I’ve encapsulated the act of pulling links from a large HTML string in <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2phY2tkYW5nZXIvY29sbGVjdGxpbmtz">this project</span> and you’re welcome to check out the code if you’re interested.</p>
<p>Now let’s modify our code to extract links from whatever page is provided and print those links to the screen:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;flag&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/jackdanger/collectlinks&quot;</span>  <span class="comment">// This is the little library I made for</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span>                            <span class="comment">// parsing links. Go natively allows sourcing</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span>                                  <span class="comment">// Github projects as dependencies. They&#x27;ll be</span></span><br><span class="line">)                                       <span class="comment">// downloaded to $GOPATH/src/github.com/... on your</span></span><br><span class="line">                                        <span class="comment">// filesystem but you don&#x27;t have to worry about that.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resp, err := http.Get(args[<span class="number">0</span>])</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  links := collectlinks.All(resp.Body)  <span class="comment">// Here we use the collectlinks package</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span>(links) &#123;  <span class="comment">// &#x27;for&#x27; + &#x27;range&#x27; in Go is like .each in Ruby or</span></span><br><span class="line">    fmt.Println(link)            <span class="comment">// an iterator in many other languages.</span></span><br><span class="line">  &#125;                              <span class="comment">// When we call range() on a list each iteration of the</span></span><br><span class="line">&#125;                                <span class="comment">// contents will set two variables: the index and the value.</span></span><br><span class="line">                                 <span class="comment">// Here we don&#x27;t care about the index so we set it to &#x27;_&#x27;</span></span><br><span class="line">                                 <span class="comment">// because if we write &#x27;for index, link := range(links)&#x27;</span></span><br><span class="line">                                 <span class="comment">// Go would point out that we left &#x27;index&#x27; unused.</span></span><br></pre></td></tr></table></figure>
<p>If you run this against a simple website this’ll work fine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run crawl.go http://6brand.com</span><br></pre></td></tr></table></figure>
<p>But if you try to run it against an https-secured site it may error out because it can’t validate the SSL cert. We don’t care about security in this toy app so let’s disable the SSL verification.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;crypto/tls&quot;</span>   <span class="comment">// we&#x27;ll import this package to get access to some</span></span><br><span class="line">  <span class="string">&quot;flag&quot;</span>         <span class="comment">// low-level transport customizations</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/jackdanger/collectlinks&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tlsConfig := &amp;tls.Config&#123;                 <span class="comment">// The &amp;thing&#123;a: b&#125; syntax is equivalent to</span></span><br><span class="line">                 InsecureSkipVerify: <span class="literal">true</span>,  <span class="comment">// new(thing(a: b)) in other languages.</span></span><br><span class="line">               &#125;                            <span class="comment">// It gives you a new &#x27;thing&#x27; object (in this</span></span><br><span class="line">                                            <span class="comment">// case a new &#x27;tls.Config&#x27; object) and sets the</span></span><br><span class="line">                                            <span class="comment">// &#x27;a&#x27; attribute to a value of &#x27;b&#x27;.</span></span><br><span class="line"></span><br><span class="line">  transport := &amp;http.Transport&#123;    <span class="comment">// And we take that tlsConfig object we instantiated</span></span><br><span class="line">    TLSClientConfig: tlsConfig,    <span class="comment">// and use it as the value for another new object&#x27;s</span></span><br><span class="line">  &#125;                                <span class="comment">// &#x27;TLSClientConfig&#x27; attribute.</span></span><br><span class="line"></span><br><span class="line">  client := http.Client&#123;Transport: transport&#125;  <span class="comment">// Go typicaly gives you sane defaults (like &#x27;http.Get&#x27;)</span></span><br><span class="line">                                               <span class="comment">// and also provides a way to override them.</span></span><br><span class="line"></span><br><span class="line">  resp, err := client.Get(args[<span class="number">0</span>])  <span class="comment">// this line is basically the same as before, only</span></span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;                   <span class="comment">// we&#x27;re calling &#x27;Get&#x27; on a customized client rather</span></span><br><span class="line">    <span class="keyword">return</span>                          <span class="comment">// than the &#x27;http&#x27; package directly.</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  links := collectlinks.All(resp.Body)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span>(links) &#123;</span><br><span class="line">    fmt.Println(link)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-4-concurrency"><a class="markdownIt-Anchor" href="#step-4-concurrency">#</a> Step 4. Concurrency</h2>
<p>I’ve asked programming questions that required work similar to what we’re doing here in programming interviews and the step that candidates need the most help with is building some kind of queue. If you were to crawl the internet without queueing up the links you found you’d just visit the top link of every page and rapidly, in a depth-first search across the whole web, exhaust your resources without ever visiting the second link on the first page. To avoid that we need to keep some kind of queue where we put links we find in the back of it and we visit pages that we pull off the front of the queue.</p>
<p>In C# we’d using a  <code>ConsumingQueue</code> , in Ruby we’d probably require the stdlib’s  <code>Queue</code> , and in Java we’d use a  <code>ConcurrentLinkedQueue</code>  or something. Go gives us a great alternative: a channel. It’s kinda like a lightweight thread that abstracts away some concurrency primitives for you and functions much like a queue.</p>
<p>We’ll create a channel when we start the program and we’ll put our starting URL into it. Then we’ll begin to read URLs from the channel and whenever we find new URLs we’ll write them to the channel, effectively putting them into the back of our queue.</p>
<p>The queue will grow continuously over time because we’re putting things in faster than we take them out but we just don’t care.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//// file: crawl.go</span></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">  <span class="string">&quot;flag&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/jackdanger/collectlinks&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  queue := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)         <span class="comment">// This gives you a new channel that</span></span><br><span class="line">                                     <span class="comment">// receives and delivers strings. There&#x27;s nothing</span></span><br><span class="line">                                     <span class="comment">// more you need to do to set it up – it&#x27;s</span></span><br><span class="line">                                     <span class="comment">// all ready to have data fed into it.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;            <span class="comment">// saying &quot;go someFunction()&quot; means</span></span><br><span class="line">                         <span class="comment">// &quot;run someFunction() asynchronously&quot;</span></span><br><span class="line">    queue &lt;- args[<span class="number">0</span>]     <span class="comment">// This means &quot;put args[0] into the channel&quot;.</span></span><br><span class="line">  &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> uri := <span class="keyword">range</span> queue &#123;     <span class="comment">// &#x27;range&#x27; is such an effective iterator keyword</span></span><br><span class="line">                               <span class="comment">// that if you ask for the range of a channel it&#x27;ll</span></span><br><span class="line">                               <span class="comment">// do an efficient, continuous blocking read of</span></span><br><span class="line">                               <span class="comment">// all the channel contents.</span></span><br><span class="line"></span><br><span class="line">    enqueue(uri, queue)  <span class="comment">// we pass each URL we find off to be read &amp; enqueued</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enqueue</span><span class="params">(uri <span class="keyword">string</span>, queue <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;fetching&quot;</span>, uri)</span><br><span class="line">  tlsConfig := &amp;tls.Config&#123;</span><br><span class="line">    InsecureSkipVerify: <span class="literal">true</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  transport := &amp;http.Transport&#123;</span><br><span class="line">    TLSClientConfig: tlsConfig,</span><br><span class="line">  &#125;</span><br><span class="line">  client := http.Client&#123;Transport: transport&#125;</span><br><span class="line">  resp, err := client.Get(uri)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  links := collectlinks.All(resp.Body)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span> links &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; queue &lt;- link &#125;() <span class="comment">// We asynchronously enqueue what we&#x27;ve found</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The flow now is that  <code>main</code>  has a  <code>for</code>  loop reading from the channel called  <code>queue</code>  and  <code>enqueue</code>  does the HTTP retrieval and link parsing, putting the discovered links into the same queue used by  <code>main</code> .</p>
<p>If you try running our code so far it’ll work but you’ll immediately discover two things: The World Wide Web is a messy place full of invalid links and most pages link to themselves.</p>
<p>So let’s add some sanity to our code.</p>
<h2 id="step-5-data-sanitization"><a class="markdownIt-Anchor" href="#step-5-data-sanitization">#</a> Step 5. Data sanitization</h2>
<p>To properly explore the web let’s turn all of the relative links we find into absolute links.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">  <span class="string">&quot;flag&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/jackdanger/collectlinks&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;net/url&quot;</span>  <span class="comment">// We&#x27;re going to use the standard library</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span>       <span class="comment">// to fix our URLs</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  queue := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; queue &lt;- args[<span class="number">0</span>] &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> uri := <span class="keyword">range</span> queue &#123;</span><br><span class="line">    enqueue(uri, queue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enqueue</span><span class="params">(uri <span class="keyword">string</span>, queue <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;fetching&quot;</span>, uri)</span><br><span class="line">  transport := &amp;http.Transport&#123;</span><br><span class="line">    TLSClientConfig: &amp;tls.Config&#123;</span><br><span class="line">      InsecureSkipVerify: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  client := http.Client&#123;Transport: transport&#125;</span><br><span class="line">  resp, err := client.Get(uri)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  links := collectlinks.All(resp.Body)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span> links &#123;</span><br><span class="line">    absolute := fixUrl(link, uri)      <span class="comment">// Don&#x27;t enqueue the raw thing we find,</span></span><br><span class="line">                                       <span class="comment">// fix it first.</span></span><br><span class="line">    <span class="keyword">if</span> uri != <span class="string">&quot;&quot;</span> &#123;                     <span class="comment">// We&#x27;ll set invalid URLs to blank strings</span></span><br><span class="line">                                       <span class="comment">// so let&#x27;s never send those to the channel.</span></span><br><span class="line">      <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; queue &lt;- absolute &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fixUrl</span><span class="params">(href, base <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>)</span></span> &#123;  <span class="comment">// given a relative link and the page on</span></span><br><span class="line">  uri, err := url.Parse(href)              <span class="comment">// which it&#x27;s found we can parse them</span></span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;                          <span class="comment">// both and use the url package&#x27;s</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>                              <span class="comment">// ResolveReference function to figure</span></span><br><span class="line">  &#125;                                        <span class="comment">// out where the link really points.</span></span><br><span class="line">  baseUrl, err := url.Parse(base)          <span class="comment">// If it&#x27;s not a relative link this</span></span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;                          <span class="comment">// is a no-op.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  uri = baseUrl.ResolveReference(uri)</span><br><span class="line">  <span class="keyword">return</span> uri.String()                      <span class="comment">// We work with parsed url objects in this</span></span><br><span class="line">&#125;                                          <span class="comment">// func but we return a plain string.</span></span><br></pre></td></tr></table></figure>
<p>Now you’re cookin’. This program will now pretty reliably walk around the web downloading and parsing pages. However, there’s still one thing we lack.</p>
<h2 id="step-6-avoiding-loops"><a class="markdownIt-Anchor" href="#step-6-avoiding-loops">#</a> Step 6. Avoiding Loops</h2>
<p>Nothing so far prevents us from visiting a page that has one link pointing to itself and just looping on that single page forever. That’s dumb, let’s not fetch any page more than once.</p>
<p>The right data structure for keeping track of the presence or absense of things is a set. Go, like Javascript, doesn’t have a native way of doing sets so we need to use a map (a.k.a a hash or hashmap or a dictionary) with urls as keys to keep track of which pages we’ve visited.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;crypto/tls&quot;</span></span><br><span class="line">  <span class="string">&quot;flag&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/jackdanger/collectlinks&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;net/url&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">                                     <span class="comment">// Putting a variable outside a function is Go&#x27;s</span></span><br><span class="line"><span class="keyword">var</span> visited = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)  <span class="comment">// version of a global variable.</span></span><br><span class="line">                                     <span class="comment">// This is a map of string -&gt; bool, so</span></span><br><span class="line">                                     <span class="comment">// visited[&quot;hi&quot;] works but visited[6] doesn&#x27;t.</span></span><br><span class="line">                                     <span class="comment">// Setting a value in a map is a simple as:</span></span><br><span class="line">                                     <span class="comment">//   visited[&quot;google.com&quot;] = true</span></span><br><span class="line">                                     <span class="comment">// and reading is equally so:</span></span><br><span class="line">                                     <span class="comment">//   visited[&quot;google.com&quot;]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  flag.Parse()</span><br><span class="line"></span><br><span class="line">  args := flag.Args()</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Please specify start page&quot;</span>)</span><br><span class="line">    os.Exit(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  queue := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; queue &lt;- args[<span class="number">0</span>] &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> uri := <span class="keyword">range</span> queue &#123;</span><br><span class="line">    enqueue(uri, queue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">enqueue</span><span class="params">(uri <span class="keyword">string</span>, queue <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;fetching&quot;</span>, uri)</span><br><span class="line">  visited[uri] = <span class="literal">true</span>                        <span class="comment">// Record that we&#x27;re going to visit this page</span></span><br><span class="line">  transport := &amp;http.Transport&#123;</span><br><span class="line">    TLSClientConfig: &amp;tls.Config&#123;</span><br><span class="line">      InsecureSkipVerify: <span class="literal">true</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  client := http.Client&#123;Transport: transport&#125;</span><br><span class="line">  resp, err := client.Get(uri)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">  links := collectlinks.All(resp.Body)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span> links &#123;</span><br><span class="line">    absolute := fixUrl(link, uri)</span><br><span class="line">    <span class="keyword">if</span> uri != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> !visited[absolute] &#123;          <span class="comment">// Don&#x27;t enqueue a page twice!</span></span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; queue &lt;- absolute &#125;()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fixUrl</span><span class="params">(href, base <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  uri, err := url.Parse(href)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  baseUrl, err := url.Parse(base)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  uri = baseUrl.ResolveReference(uri)</span><br><span class="line">  <span class="keyword">return</span> uri.String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And now you can start at any html page you like and slowly explore the entire world wide web.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run crawl.go http://6brand.com</span><br></pre></td></tr></table></figure>
<p>Full source code is available <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0phY2tEYW5nZXIvZ29jcmF3bGVy">on GitHub</span> as well.</p>

      <div class="tags">
          <a href="/tags/go/" rel="tag"><i class="ic i-tag"></i> go</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2021-10-18 13:27:09" itemprop="dateModified" datetime="2021-10-18T13:27:09+08:00">2021-10-18</time>
  </span>
</div>

      

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2020/03/17/go-question/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciusoyjnj219g0u0x56.jpg" title="Go Question">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Go Question</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2020/04/14/c-complation/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclxxcb6rj20zk0m8b29.jpg" title="The C compilation process">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>The C compilation process</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#starting-a-new-project-with-go"><span class="toc-number">1.</span> <span class="toc-text"> Starting a new project with Go</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#creating-the-main-function"><span class="toc-number">2.</span> <span class="toc-text"> Creating the ‘main’ function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#whats-a-web-crawler"><span class="toc-number">3.</span> <span class="toc-text"> What’s a web crawler?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-1-starting-from-a-specific-page"><span class="toc-number">4.</span> <span class="toc-text"> Step 1. Starting from a specific page</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-2-retrieving-a-page-from-the-internet"><span class="toc-number">5.</span> <span class="toc-text"> Step 2. Retrieving a page from the internet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-3-parsing-hyperlinks-from-html"><span class="toc-number">6.</span> <span class="toc-text"> Step 3. Parsing hyperlinks from HTML</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-4-concurrency"><span class="toc-number">7.</span> <span class="toc-text"> Step 4. Concurrency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-5-data-sanitization"><span class="toc-number">8.</span> <span class="toc-text"> Step 5. Data sanitization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-6-avoiding-loops"><span class="toc-number">9.</span> <span class="toc-text"> Step 6. Avoiding Loops</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="江边鸟"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">江边鸟</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">276</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">2</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">40</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xoY2hlbjc0" title="https:&#x2F;&#x2F;github.com&#x2F;lhchen74"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLw==" title="https:&#x2F;&#x2F;music.163.com&#x2F;"><i class="ic i-cloud-music"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>Friends</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2020/03/17/go-question/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2020/04/14/c-complation/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">江边鸟 @ D E W</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2020/03/18/go-crawler/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
