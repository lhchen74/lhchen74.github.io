



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="露の世" href="https://lhchen74.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="露の世" href="https://lhchen74.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="露の世" href="https://lhchen74.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="db" />


<link rel="canonical" href="https://lhchen74.github.io/2020/07/24/oracel-merge/">



  <title>
oracle merge |
Dew's World = 露の世</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">oracle merge
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2020-07-24 00:00:00">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2020-07-24T00:00:00+08:00">2020-07-24</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Dew's World</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclil3m4ej20zk0m8tn8.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclfdu6exj20zk0m87hw.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipev1x5e4j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipevo9j1jj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclfw2t96j20zk0m8x6p.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://lhchen74.github.io/2020/07/24/oracel-merge/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="江边鸟">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="露の世">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <blockquote>
<p>转载:<span class="exturl" data-url="aHR0cHM6Ly9vcmFjbGUtYmFzZS5jb20vYXJ0aWNsZXMvMTBnL21lcmdlLWVuaGFuY2VtZW50cy0xMGc=">ORACLE-BASE - MERGE Statement Enhancements in Oracle Database 10g</span></p>
</blockquote>
<h3 id="test-table"><a class="markdownIt-Anchor" href="#test-table">#</a> Test Table</h3>
<p>The following examples use the table defined below.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test1 <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span>   all_objects</span><br><span class="line"><span class="keyword">WHERE</span>  <span class="number">1</span><span class="operator">=</span><span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h3 id="optional-clauses"><a class="markdownIt-Anchor" href="#optional-clauses">#</a> Optional Clauses</h3>
<p>The  <code>MATCHED</code>  and  <code>NOT MATCHED</code>  clauses are now optional making all of the following examples valid.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Both clauses present.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span> a.status <span class="operator">=</span> b.status</span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    <span class="keyword">INSERT</span> (object_id, status)</span><br><span class="line">    <span class="keyword">VALUES</span> (b.object_id, b.status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- No matched clause, insert only.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    <span class="keyword">INSERT</span> (object_id, status)</span><br><span class="line">    <span class="keyword">VALUES</span> (b.object_id, b.status);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- No not-matched clause, update only.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span> a.status <span class="operator">=</span> b.status;</span><br></pre></td></tr></table></figure>
<h3 id="conditional-operations"><a class="markdownIt-Anchor" href="#conditional-operations">#</a> Conditional Operations</h3>
<p>Conditional inserts and updates are now possible by using a  <code>WHERE</code>  clause on these statements.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Both clauses present.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span> a.status <span class="operator">=</span> b.status</span><br><span class="line">    <span class="keyword">WHERE</span>  b.status <span class="operator">!=</span> <span class="string">&#x27;VALID&#x27;</span></span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    <span class="keyword">INSERT</span> (object_id, status)</span><br><span class="line">    <span class="keyword">VALUES</span> (b.object_id, b.status)</span><br><span class="line">    <span class="keyword">WHERE</span>  b.status <span class="operator">!=</span> <span class="string">&#x27;VALID&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- No matched clause, insert only.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> <span class="keyword">NOT</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    <span class="keyword">INSERT</span> (object_id, status)</span><br><span class="line">    <span class="keyword">VALUES</span> (b.object_id, b.status)</span><br><span class="line">    <span class="keyword">WHERE</span>  b.status <span class="operator">!=</span> <span class="string">&#x27;VALID&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- No not-matched clause, update only.</span></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> test1 a</span><br><span class="line">  <span class="keyword">USING</span> all_objects b</span><br><span class="line">    <span class="keyword">ON</span> (a.object_id <span class="operator">=</span> b.object_id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span> a.status <span class="operator">=</span> b.status</span><br><span class="line">    <span class="keyword">WHERE</span>  b.status <span class="operator">!=</span> <span class="string">&#x27;VALID&#x27;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="delete-clause"><a class="markdownIt-Anchor" href="#delete-clause">#</a> DELETE Clause</h3>
<p>An optional  <code>DELETE WHERE</code>  clause can be added to the  <code>MATCHED</code>  clause to clean up after a merge operation. Only those rows in the destination table that match both the  <code>ON</code>  clause and the  <code>DELETE WHERE</code>  are deleted. If you add a  <code>WHERE</code>  clause to the update in the matched clause, we can think of this as additional match criteria for the delete, as only rows that are touched by the update are available for the  <code>DELETE</code>  clause to remove. Depending on which table the  <code>DELETE WHERE</code>  references, it can target the rows prior or post update. The following examples clarify this.</p>
<p>Create a source table with 5 rows as follows.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> source <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> level <span class="keyword">AS</span> id,</span><br><span class="line">       <span class="keyword">CASE</span></span><br><span class="line">         <span class="keyword">WHEN</span> <span class="built_in">MOD</span>(level, <span class="number">2</span>) <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">10</span></span><br><span class="line">         <span class="keyword">ELSE</span> <span class="number">20</span></span><br><span class="line">       <span class="keyword">END</span> <span class="keyword">AS</span> status,</span><br><span class="line">       <span class="string">&#x27;Description of level &#x27;</span> <span class="operator">||</span> level <span class="keyword">AS</span> description</span><br><span class="line"><span class="keyword">FROM</span>   dual</span><br><span class="line"><span class="keyword">CONNECT</span> <span class="keyword">BY</span> level <span class="operator">&lt;=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> source;</span><br><span class="line"></span><br><span class="line">        ID     STATUS DESCRIPTION</span><br><span class="line"><span class="comment">---------- ---------- -----------------------</span></span><br><span class="line">         <span class="number">1</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">1</span></span><br><span class="line">         <span class="number">2</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">2</span></span><br><span class="line">         <span class="number">3</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">3</span></span><br><span class="line">         <span class="number">4</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">4</span></span><br><span class="line">         <span class="number">5</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>Create the destination table using a similar query, but this time with 10 rows.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> destination <span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> level <span class="keyword">AS</span> id,</span><br><span class="line">       <span class="keyword">CASE</span></span><br><span class="line">         <span class="keyword">WHEN</span> <span class="built_in">MOD</span>(level, <span class="number">2</span>) <span class="operator">=</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">10</span></span><br><span class="line">         <span class="keyword">ELSE</span> <span class="number">20</span></span><br><span class="line">       <span class="keyword">END</span> <span class="keyword">AS</span> status,</span><br><span class="line">       <span class="string">&#x27;Description of level &#x27;</span> <span class="operator">||</span> level <span class="keyword">AS</span> description</span><br><span class="line"><span class="keyword">FROM</span>   dual</span><br><span class="line"><span class="keyword">CONNECT</span> <span class="keyword">BY</span> level <span class="operator">&lt;=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> destination;</span><br><span class="line"></span><br><span class="line">         <span class="number">1</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">1</span></span><br><span class="line">         <span class="number">2</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">2</span></span><br><span class="line">         <span class="number">3</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">3</span></span><br><span class="line">         <span class="number">4</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">4</span></span><br><span class="line">         <span class="number">5</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">5</span></span><br><span class="line">         <span class="number">6</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">6</span></span><br><span class="line">         <span class="number">7</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">7</span></span><br><span class="line">         <span class="number">8</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">8</span></span><br><span class="line">         <span class="number">9</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">9</span></span><br><span class="line">        <span class="number">10</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>The following  <code>MERGE</code>  statement will update all the rows in the destination table that have a matching row in the source table. The additional  <code>DELETE WHERE</code>  clause will delete only those rows that were matched, already in the destination table, and meet the criteria of the  <code>DELETE WHERE</code>  clause.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> destination d</span><br><span class="line">  <span class="keyword">USING</span> source s</span><br><span class="line">    <span class="keyword">ON</span> (s.id <span class="operator">=</span> d.id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span> d.description <span class="operator">=</span> <span class="string">&#x27;Updated&#x27;</span></span><br><span class="line">    <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> d.status <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> merged.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> destination;</span><br><span class="line"></span><br><span class="line">        ID     STATUS DESCRIPTION</span><br><span class="line"><span class="comment">---------- ---------- -----------------------</span></span><br><span class="line">         <span class="number">1</span>         <span class="number">20</span> Updated</span><br><span class="line">         <span class="number">3</span>         <span class="number">20</span> Updated</span><br><span class="line">         <span class="number">5</span>         <span class="number">20</span> Updated</span><br><span class="line">         <span class="number">6</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">6</span></span><br><span class="line">         <span class="number">7</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">7</span></span><br><span class="line">         <span class="number">8</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">8</span></span><br><span class="line">         <span class="number">9</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">9</span></span><br><span class="line">        <span class="number">10</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>Notice there are rows with a status of “10” that were not deleted. This is because there was no match between the source and destination for these rows, so the delete was not applicable.</p>
<p>The following example shows the  <code>DELETE WHERE</code>  can be made to match against values of the rows before the update operation, not after. In this case, all matching rows have their status changed to “10”, but the  <code>DELETE WHERE</code>  references the source data, so the status is checked against the source, not the updated values.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> destination d</span><br><span class="line">  <span class="keyword">USING</span> source s</span><br><span class="line">    <span class="keyword">ON</span> (s.id <span class="operator">=</span> d.id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span>  d.description <span class="operator">=</span> <span class="string">&#x27;Updated&#x27;</span>,</span><br><span class="line">                d.status <span class="operator">=</span> <span class="number">10</span></span><br><span class="line">    <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> s.status <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> merged.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> destination;</span><br><span class="line"></span><br><span class="line">        ID     STATUS DESCRIPTION</span><br><span class="line"><span class="comment">---------- ---------- -----------------------</span></span><br><span class="line">         <span class="number">1</span>         <span class="number">10</span> Updated</span><br><span class="line">         <span class="number">3</span>         <span class="number">10</span> Updated</span><br><span class="line">         <span class="number">5</span>         <span class="number">10</span> Updated</span><br><span class="line">         <span class="number">6</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">6</span></span><br><span class="line">         <span class="number">7</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">7</span></span><br><span class="line">         <span class="number">8</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">8</span></span><br><span class="line">         <span class="number">9</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">9</span></span><br><span class="line">        <span class="number">10</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span> <span class="keyword">rows</span> selected.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>
<p>Notice, no extra rows were deleted compared to the previous example.</p>
<p>By switching the DELETE WHERE to reference the destination table, the extra updated rows can be deleted also.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ROLLBACK</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">MERGE</span> <span class="keyword">INTO</span> destination d</span><br><span class="line">  <span class="keyword">USING</span> source s</span><br><span class="line">    <span class="keyword">ON</span> (s.id <span class="operator">=</span> d.id)</span><br><span class="line">  <span class="keyword">WHEN</span> MATCHED <span class="keyword">THEN</span></span><br><span class="line">    UPDATE <span class="keyword">SET</span>  d.description <span class="operator">=</span> <span class="string">&#x27;Updated&#x27;</span>,</span><br><span class="line">                d.status <span class="operator">=</span> <span class="number">10</span></span><br><span class="line">    <span class="keyword">DELETE</span> <span class="keyword">WHERE</span> d.status <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> merged.</span><br><span class="line"></span><br><span class="line"><span class="keyword">SQL</span><span class="operator">&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> destination;</span><br><span class="line"></span><br><span class="line">        ID     STATUS DESCRIPTION</span><br><span class="line"><span class="comment">---------- ---------- -----------------------</span></span><br><span class="line">         <span class="number">6</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">6</span></span><br><span class="line">         <span class="number">7</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">7</span></span><br><span class="line">         <span class="number">8</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">8</span></span><br><span class="line">         <span class="number">9</span>         <span class="number">20</span> Description <span class="keyword">of</span> level <span class="number">9</span></span><br><span class="line">        <span class="number">10</span>         <span class="number">10</span> Description <span class="keyword">of</span> level <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> <span class="keyword">rows</span> selected.</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/db/" rel="tag"><i class="ic i-tag"></i> db</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2021-05-26 16:07:00" itemprop="dateModified" datetime="2021-05-26T16:07:00+08:00">2021-05-26</time>
  </span>
</div>

      

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2020/07/24/oracle-connect-by/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipex2cdtbj20zk0m8x6p.jpg" title="Hierarchical Queries in Oracle">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Hierarchical Queries in Oracle</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2020/08/01/rust-error/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipey84bjtj20zk0m8hdt.jpg" title="Beginner&#39;s guide to Error Handling in Rust">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Beginner's guide to Error Handling in Rust</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#test-table"><span class="toc-number">1.</span> <span class="toc-text"> Test Table</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#optional-clauses"><span class="toc-number">2.</span> <span class="toc-text"> Optional Clauses</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#conditional-operations"><span class="toc-number">3.</span> <span class="toc-text"> Conditional Operations</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delete-clause"><span class="toc-number">4.</span> <span class="toc-text"> DELETE Clause</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="江边鸟"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">江边鸟</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">247</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">1</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">41</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xoY2hlbjc0" title="https:&#x2F;&#x2F;github.com&#x2F;lhchen74"><i class="ic i-github"></i></span>
      <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;twitter.com&#x2F;yourname"><i class="ic i-twitter"></i></span>
      <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yourname"><i class="ic i-zhihu"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPXlvdXJpZA==" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;yourid"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly9hYm91dC5tZS95b3VybmFtZQ==" title="https:&#x2F;&#x2F;about.me&#x2F;yourname"><i class="ic i-address-card"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>About</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>Posts</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>Archives</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>Categories</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>Tags</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>friends</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-magic"></i>links</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2020/07/24/oracle-connect-by/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2020/08/01/rust-error/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2021</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">江边鸟 @ Dew's World</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2020/07/24/oracel-merge/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
